<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>딜리래빗 간선비용 계산기</title>
  
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --border: #e6e8f0;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #6366f1;
      --saved: #10b981;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 10; }
    header .title { font-size: 18px; font-weight: 700; }
    .container { display: grid; grid-template-columns: 380px 1fr; gap: 14px; padding: 14px; height: calc(100vh - 66px); }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; overflow-y: auto; }
    .panel h3 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 700; letter-spacing: .02em; }
    .control { margin-bottom: 10px; }
    .control label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .control input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 9px 12px; border: 1px solid var(--border); border-radius: 10px; background:#fff; cursor: pointer; font-weight: 600; font-size: 13px; }
    .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn.success { background: var(--saved); color: #fff; border-color: var(--saved); }
    .btn.warning { background: var(--warning); color: #fff; border-color: var(--warning); }
    .btn.danger { background: #ef4444; color: #fff; border-color: #ef4444; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .hint { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    #map { width: 100%; height: 100%; border-radius: 14px; }
    .kpi { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .kpi .card { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #fff; }
    .kpi .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .value { font-size: 18px; font-weight: 800; }
    .slack { border: 1px dashed var(--border); border-radius: 10px; padding: 10px; background:#fafbff; }
    .small { font-size: 12px; color: var(--muted); }
    .waypoints { font-size: 13px; margin: 8px 0; color: #374151; }
    .waypoints code { background: #f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; }
    
    .search-container { position: relative; }
    .search-results { 
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0; 
      background: white; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      max-height: 200px; 
      overflow-y: auto; 
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .search-result { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 13px; }
    .search-result:hover { background: #f9fafb; }
    .search-result:last-child { border-bottom: none; }
    
    .saved-locations { margin-top: 10px; }
    .saved-location { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 8px 10px; 
      margin-bottom: 6px; 
      background: #f8fafc; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      font-size: 13px;
    }
    .saved-location .name { font-weight: 500; }
    .saved-location .actions { display: flex; gap: 4px; }
    .saved-location .btn { padding: 4px 8px; font-size: 11px; }
    
    .location-selector { margin-bottom: 10px; }
    .location-dropdown { 
      width: 100%; 
      padding: 8px 10px; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      font-size: 13px; 
      background: white;
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        height: auto;
        min-height: calc(100vh - 66px);
      }
      .panel:first-child {
        order: 2;
      }
      #map {
        height: 400px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">딜리래빗 간선비용 계산기 (카카오맵)</div>
  </header>

  <div class="container">
    <!-- Left Controls -->
    <section class="panel" id="panel">
      <h3>위치 검색 및 저장</h3>
      <div class="control search-container">
        <label>위치 검색 (주소, 건물명, 랜드마크 등)</label>
        <input type="text" id="searchInput" placeholder="예: 강남역, 서울시 강남구 테헤란로 152">
        <div class="search-results" id="searchResults" style="display: none;"></div>
      </div>
      <div class="hint">검색 후 결과를 클릭하면 지도에 표시됩니다. 저장 버튼을 눌러 위치를 영구 저장하세요.</div>
      
      <div class="control">
        <button class="btn success" id="saveLocationBtn" disabled>현재 위치 저장</button>
      </div>

      <h3>저장된 위치</h3>
      <div class="saved-locations" id="savedLocations">
        <div class="hint">저장된 위치가 없습니다.</div>
      </div>

      <h3>경로 설정</h3>
      <div class="hint">
        <strong>방법 1:</strong> 지도를 클릭해서 출발지 → 도착지 순서로 설정<br>
        <strong>방법 2:</strong> 아래 드롭다운에서 저장된 위치 선택
      </div>
      
      <div class="location-selector">
        <label>출발지 선택</label>
        <select class="location-dropdown" id="startSelect">
          <option value="">선택하세요</option>
        </select>
      </div>
      
      <div class="location-selector">
        <label>도착지 선택</label>
        <select class="location-dropdown" id="endSelect">
          <option value="">선택하세요</option>
        </select>
      </div>

      <div class="control">
        <div class="row3">
          <button class="btn" id="addWaypointBtn">경유지 추가</button>
          <button class="btn" id="undoBtn">마지막 제거</button>
          <button class="btn danger" id="resetBtn">초기화</button>
        </div>
      </div>

      <h3>단가 모델</h3>
      <div class="row">
        <div class="control">
          <label>기본 요금(₩)</label>
          <input type="number" id="baseFee" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>KM 단가(₩/km)</label>
          <input type="number" id="perKm" value="1000" min="0" step="10">
        </div>
      </div>
      <div class="row">
        <div class="control">
          <label>경유지 추가요금(₩/개)</label>
          <input type="number" id="perStop" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>최소 요금(₩, 선택)</label>
          <input type="number" id="minFee" value="0" min="0" step="100">
        </div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="label">총 거리</div>
          <div class="value"><span id="km">0.0</span> km</div>
        </div>
        <div class="card">
          <div class="label">예상 간선비</div>
          <div class="value">₩ <span id="cost">0</span></div>
        </div>
      </div>

      <h3>경유지</h3>
      <div class="waypoints" id="wpList">경로를 설정하면 여기에 순서가 표시됩니다.</div>

      <h3>슬랙 공유</h3>
      <div class="slack">
        <div class="small">메시지 미리보기</div>
        <pre id="slackText" style="white-space: pre-wrap; margin:8px 0;"></pre>
        <button class="btn primary" id="copyBtn">메시지 복사</button>
      </div>
    </section>

    <!-- Map -->
    <section class="panel">
      <div id="map"></div>
    </section>
  </div>

  <!-- 카카오맵 API 로드 - 기본 방식으로 복원 -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=961ad1fa29e637215fcfab22903bfbb5&libraries=services"></script>
  
  <script>
    // --- Data Storage (in-memory) ---
    let savedLocations = []; // {id, name, lat, lng, address}
    let currentSearchResult = null; // temporary location before saving

    // --- Map Init ---
    let map, ps, geocoder;
    let waypoints = [];
    let markers = [];
    let savedLocationMarkers = new Map(); // id -> marker
    let waypointMode = 'auto'; // 'auto' or 'waypoint'
    let polyline = null; // 경로를 그리는 폴리라인

    // 카카오맵 초기화
    function initMap() {
      try {
        const container = document.getElementById('map');
        const options = {
          center: new kakao.maps.LatLng(37.5665, 126.9780), // 서울 중심
          level: 8
        };

        map = new kakao.maps.Map(container, options);
        ps = new kakao.maps.services.Places(); // 장소 검색 서비스
        geocoder = new kakao.maps.services.Geocoder(); // 좌표-주소 변환 서비스

        // 지도 클릭 이벤트
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
          const latlng = mouseEvent.latLng;
          
          if (waypointMode === 'waypoint') {
            if (waypoints.length >= 2) {
              addWaypoint(latlng);
              waypointMode = 'auto';
              updateAddWaypointButton();
            }
          } else {
            if (waypoints.length < 2) {
              addWaypoint(latlng);
            }
          }
        });

        console.log('카카오맵 및 검색 서비스 초기화 완료');
      } catch (error) {
        console.error('카카오맵 초기화 오류:', error);
        document.getElementById('map').innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
            <p style="font-size: 16px; margin-bottom: 10px;">⚠️ 카카오맵 API 로드 실패</p>
            <p style="font-size: 14px; text-align: center;">JavaScript 키를 올바르게 설정했는지 확인해주세요.</p>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">
              <a href="https://developers.kakao.com" target="_blank">카카오 개발자사이트</a>에서 키를 발급받으세요.
            </p>
          </div>
        `;
      }
    }

    // DOM이 로드된 후 초기화
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof kakao !== 'undefined' && kakao.maps) {
        initMap();
      } else {
        // 스크립트 로딩을 기다림
        let attempts = 0;
        const checkInterval = setInterval(() => {
          attempts++;
          if (typeof kakao !== 'undefined' && kakao.maps) {
            clearInterval(checkInterval);
            initMap();
          } else if (attempts > 50) { // 5초 후 포기
            clearInterval(checkInterval);
            document.getElementById('map').innerHTML = `
              <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
                <p style="font-size: 16px; margin-bottom: 10px;">⚠️ 카카오맵 API 로드 실패</p>
                <p style="font-size: 14px; text-align: center;">네트워크 연결을 확인하고 페이지를 새로고침해주세요.</p>
              </div>
            `;
          }
        }, 100);
      }
    });

    // --- Search Functionality ---
    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const saveLocationBtn = document.getElementById('saveLocationBtn');

    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(() => searchLocation(query), 300);
    });

    // Hide search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        searchResults.style.display = 'none';
      }
    });

    function searchLocation(query) {
      if (!ps) {
        console.error('Places 서비스가 초기화되지 않음');
        searchResults.innerHTML = '<div class="search-result">검색 서비스를 초기화하는 중입니다. 잠시 후 다시 시도해주세요.</div>';
        searchResults.style.display = 'block';
        return;
      }

      console.log('검색 시작:', query);

      ps.keywordSearch(query, function(data, status) {
        console.log('검색 결과:', status, data);
        
        if (status === kakao.maps.services.Status.OK) {
          displaySearchResults(data.slice(0, 5)); // 상위 5개 결과만 표시
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
          searchResults.innerHTML = '<div class="search-result">검색 결과가 없습니다. 다른 키워드로 시도해보세요.</div>';
          searchResults.style.display = 'block';
        } else if (status === kakao.maps.services.Status.ERROR) {
          searchResults.innerHTML = '<div class="search-result">검색 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.</div>';
          searchResults.style.display = 'block';
        } else {
          console.error('예상치 못한 상태:', status);
          searchResults.innerHTML = '<div class="search-result">알 수 없는 오류가 발생했습니다.</div>';
          searchResults.style.display = 'block';
        }
      }, {
        location: map ? map.getCenter() : new kakao.maps.LatLng(37.5665, 126.9780), // 현재 지도 중심 기준 검색
        radius: 50000 // 50km 반경
      });
    }

    function displaySearchResults(results) {
      searchResults.innerHTML = results.map(place => 
        `<div class="search-result" data-lat="${place.y}" data-lng="${place.x}" data-name="${place.place_name}" data-address="${place.address_name}">
          <div style="font-weight: 500;">${place.place_name}</div>
          <div style="font-size: 11px; color: #666; margin-top: 2px;">${place.address_name}</div>
        </div>`
      ).join('');
      searchResults.style.display = 'block';
    }

    // Handle search result selection
    searchResults.addEventListener('click', (e) => {
      const result = e.target.closest('.search-result');
      if (!result) return;

      const lat = parseFloat(result.dataset.lat);
      const lng = parseFloat(result.dataset.lng);
      const name = result.dataset.name;
      const address = result.dataset.address;

      // Clear previous search result marker
      if (currentSearchResult?.marker) {
        currentSearchResult.marker.setMap(null);
      }
      if (currentSearchResult?.overlay) {
        currentSearchResult.overlay.setMap(null);
      }

      // Add temporary marker
      const markerPosition = new kakao.maps.LatLng(lat, lng);
      const marker = new kakao.maps.Marker({
        position: markerPosition,
        map: map
      });

      // 커스텀 오버레이로 검색 아이콘 표시
      const overlay = new kakao.maps.CustomOverlay({
        position: markerPosition,
        content: '<div style="background: #fff; border: 2px solid #ff6b6b; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px;">🔍</div>',
        yAnchor: 1,
        xAnchor: 0.5
      });
      overlay.setMap(map);

      currentSearchResult = { lat, lng, name: name + ' (' + address + ')', marker, overlay };
      
      map.setCenter(markerPosition);
      map.setLevel(3);
      searchResults.style.display = 'none';
      searchInput.value = name;
      saveLocationBtn.disabled = false;
    });

    // --- Save Location ---
    saveLocationBtn.addEventListener('click', () => {
      if (!currentSearchResult) return;

      const id = Date.now().toString();
      const shortName = prompt('이 위치를 저장할 이름을 입력하세요:', currentSearchResult.name.split(' (')[0]);
      
      if (!shortName) return;

      const location = {
        id,
        name: shortName,
        lat: currentSearchResult.lat,
        lng: currentSearchResult.lng,
        address: currentSearchResult.name
      };

      savedLocations.push(location);
      
      // Remove temporary marker and overlay
      if (currentSearchResult.marker) currentSearchResult.marker.setMap(null);
      if (currentSearchResult.overlay) currentSearchResult.overlay.setMap(null);
      currentSearchResult = null;
      
      // Add permanent marker
      addSavedLocationMarker(location);
      
      // Update UI
      renderSavedLocations();
      updateLocationDropdowns();
      saveLocationBtn.disabled = true;
      searchInput.value = '';
    });

    function addSavedLocationMarker(location) {
      const markerPosition = new kakao.maps.LatLng(location.lat, location.lng);
      const marker = new kakao.maps.Marker({
        position: markerPosition,
        map: map
      });

      // 저장된 위치 오버레이
      const overlay = new kakao.maps.CustomOverlay({
        position: markerPosition,
        content: `<div style="background: #fff; border: 2px solid #10b981; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">📍</div>`,
        yAnchor: 1,
        xAnchor: 0.5
      });
      overlay.setMap(map);

      // 인포윈도우
      const infowindow = new kakao.maps.InfoWindow({
        content: `<div style="padding: 5px; font-size: 12px;">${location.name}</div>`
      });

      kakao.maps.event.addListener(marker, 'mouseover', () => {
        infowindow.open(map, marker);
      });

      kakao.maps.event.addListener(marker, 'mouseout', () => {
        infowindow.close();
      });

      savedLocationMarkers.set(location.id, { marker, overlay });
    }

    function renderSavedLocations() {
      const container = document.getElementById('savedLocations');
      
      if (savedLocations.length === 0) {
        container.innerHTML = '<div class="hint">저장된 위치가 없습니다.</div>';
        return;
      }

      container.innerHTML = savedLocations.map(loc => 
        `<div class="saved-location">
          <div class="name">${loc.name}</div>
          <div class="actions">
            <button class="btn" onclick="focusLocation('${loc.id}')">📍</button>
            <button class="btn danger" onclick="deleteLocation('${loc.id}')">🗑️</button>
          </div>
        </div>`
      ).join('');
    }

    function updateLocationDropdowns() {
      const startSelect = document.getElementById('startSelect');
      const endSelect = document.getElementById('endSelect');
      
      const options = savedLocations.map(loc => 
        `<option value="${loc.id}">${loc.name}</option>`
      ).join('');
      
      startSelect.innerHTML = '<option value="">선택하세요</option>' + options;
      endSelect.innerHTML = '<option value="">선택하세요</option>' + options;
    }

    window.focusLocation = (id) => {
      const location = savedLocations.find(loc => loc.id === id);
      if (location) {
        map.setCenter(new kakao.maps.LatLng(location.lat, location.lng));
        map.setLevel(3);
      }
    };

    window.deleteLocation = (id) => {
      if (confirm('이 위치를 삭제하시겠습니까?')) {
        savedLocations = savedLocations.filter(loc => loc.id !== id);
        const markerData = savedLocationMarkers.get(id);
        if (markerData) {
          markerData.marker.setMap(null);
          markerData.overlay.setMap(null);
          savedLocationMarkers.delete(id);
        }
        renderSavedLocations();
        updateLocationDropdowns();
      }
    };

    // --- Route Planning ---
    document.getElementById('startSelect').addEventListener('change', updateRoute);
    document.getElementById('endSelect').addEventListener('change', updateRoute);

    function updateRoute() {
      const startId = document.getElementById('startSelect').value;
      const endId = document.getElementById('endSelect').value;
      
      if (!startId || !endId) return;
      
      const start = savedLocations.find(loc => loc.id === startId);
      const end = savedLocations.find(loc => loc.id === endId);
      
      if (start && end) {
        resetRoute();
        addWaypoint(new kakao.maps.LatLng(start.lat, start.lng), start.name);
        addWaypoint(new kakao.maps.LatLng(end.lat, end.lng), end.name);
      }
    }

    function addWaypoint(latlng, customName = null) {
      waypoints.push(latlng);
      const marker = new kakao.maps.Marker({
        position: latlng,
        map: map
      });

      const label = customName || ((waypoints.length === 1) ? '출발' : (waypoints.length === 2) ? '도착' : ('경유 ' + (waypoints.length-2)));
      
      // 웨이포인트 오버레이
      const color = waypoints.length === 1 ? '#22c55e' : waypoints.length === 2 ? '#ef4444' : '#f59e0b';
      const overlay = new kakao.maps.CustomOverlay({
        position: latlng,
        content: `<div style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap;">${label}</div>`,
        yAnchor: 2,
        xAnchor: 0.5
      });
      overlay.setMap(map);

      markers.push({ marker, overlay });
      
      if (waypoints.length >= 2) {
        calculateRoute();
      }
      renderWpList();
    }

    function calculateRoute() {
      // 간단한 직선 거리 계산 (실제 도로 거리 계산을 위해서는 카카오 내비게이션 API가 필요)
      if (waypoints.length < 2) return;

      let totalDistance = 0;
      const path = [];

      for (let i = 0; i < waypoints.length; i++) {
        path.push(waypoints[i]);
        if (i > 0) {
          const prevLatLng = waypoints[i-1];
          const currLatLng = waypoints[i];
          
          // 두 점 사이의 거리 계산 (하버사인 공식)
          const distance = getDistanceFromLatLonInKm(
            prevLatLng.getLat(), prevLatLng.getLng(),
            currLatLng.getLat(), currLatLng.getLng()
          );
          totalDistance += distance;
        }
      }

      // 기존 폴리라인 제거
      if (polyline) {
        polyline.setMap(null);
      }

      // 새 폴리라인 그리기
      polyline = new kakao.maps.Polyline({
        path: path,
        strokeWeight: 6,
        strokeColor: '#6366f1',
        strokeOpacity: 0.8
      });
      polyline.setMap(map);

      // 거리 업데이트
      document.getElementById('km').textContent = totalDistance.toFixed(1);
      renderCost();
    }

    // 하버사인 공식으로 두 좌표 간 거리 계산
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371; // 지구 반지름 (km)
      const dLat = deg2rad(lat2-lat1);
      const dLon = deg2rad(lon2-lon1); 
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      const d = R * c; // 거리 (km)
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180)
    }

    function resetRoute() {
      waypoints = [];
      markers.forEach(m => {
        m.marker.setMap(null);
        m.overlay.setMap(null);
      });
      markers = [];
      if (polyline) {
        polyline.setMap(null);
        polyline = null;
      }
      document.getElementById('km').textContent = '0.0';
      waypointMode = 'auto';
      updateAddWaypointButton();
      renderWpList();
      renderCost();
    }

    function updateAddWaypointButton() {
      const btn = document.getElementById('addWaypointBtn');
      if (waypointMode === 'waypoint') {
        btn.textContent = '지도 클릭하여 경유지 추가';
        btn.classList.add('warning');
      } else {
        btn.textContent = '경유지 추가';
        btn.classList.remove('warning');
      }
    }

    // Add waypoint button
    document.getElementById('addWaypointBtn').addEventListener('click', () => {
      if (waypoints.length < 2) {
        alert('먼저 출발지와 도착지를 설정해주세요.');
        return;
      }
      waypointMode = 'waypoint';
      updateAddWaypointButton();
    });

    // Other button handlers
    document.getElementById('undoBtn').addEventListener('click', () => {
      if (waypoints.length === 0) return;
      const m = markers.pop();
      if (m) {
        m.marker.setMap(null);
        m.overlay.setMap(null);
      }
      waypoints.pop();
      if (waypoints.length >= 2) {
        calculateRoute();
      } else if (polyline) {
        polyline.setMap(null);
        polyline = null;
      }
      waypointMode = 'auto';
      updateAddWaypointButton();
      renderWpList();
      renderCost();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      resetRoute();
      document.getElementById('startSelect').value = '';
      document.getElementById('endSelect').value = '';
    });

    // Render waypoints list
    async function renderWpList() {
      const el = document.getElementById('wpList');
      if (waypoints.length === 0) {
        el.textContent = '경로를 설정하면 여기에 순서가 표시됩니다.';
        renderSlack();
        return;
      }
      
      const names = await Promise.all(waypoints.map((latlng, idx) => reverseName(latlng, idx)));
      el.innerHTML = names.map((n,i)=> `<div>${i===0?'출발':(i===1?'도착':'경유 '+(i-1))}: <code>${n}</code></div>`).join('');
      renderSlack(names);
    }

    async function reverseName(latlng, idx) {
      return new Promise((resolve) => {
        if (!geocoder) {
          resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          return;
        }

        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), (result, status) => {
          if (status === kakao.maps.services.Status.OK) {
            const address = result[0];
            if (address.road_address) {
              resolve(address.road_address.address_name);
            } else if (address.address) {
              resolve(address.address.address_name);
            } else {
              resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
            }
          } else {
            resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          }
        });
      });
    }

    // Cost calculation
    function getNumber(id) { return Math.max(0, Number(document.getElementById(id).value || 0)); }

    function calcCost(km) {
      const base = getNumber('baseFee');
      const perKm = getNumber('perKm');
      const perStop = getNumber('perStop');
      const minFee = getNumber('minFee');

      const extraStops = Math.max(0, waypoints.length - 2);
      let cost = base + (km * perKm) + (extraStops * perStop);
      if (minFee > 0) cost = Math.max(cost, minFee);
      cost = Math.round(cost / 10) * 10;
      return cost;
    }

    function renderCost() {
      const km = Number(document.getElementById('km').textContent) || 0;
      const cost = calcCost(km);
      document.getElementById('cost').textContent = cost.toLocaleString('ko-KR');
      renderSlack();
    }

    // Slack message
    function renderSlack(namesOpt) {
      const km = Number(document.getElementById('km').textContent) || 0;
      const cost = calcCost(km);
      const perKm = getNumber('perKm');
      const base = getNumber('baseFee');
      const perStop = getNumber('perStop');
      const minFee = getNumber('minFee');

      let routeText = '';
      if (namesOpt && namesOpt.length > 0) {
        routeText = namesOpt.map((n,i)=> (i===0?'출발':(i===1?'도착':'경유'+(i-1))) + ': ' + n).join(' → ');
      } else {
        routeText = waypoints.map((w,i)=> (i===0?'출발':(i===1?'도착':'경유'+(i-1)))).join(' → ');
      }

      const details = [
        `📍 노선: ${routeText || '경로 미설정'}`,
        `📏 총 거리: ${km.toFixed(1)} km`,
        `💰 단가 모델: 기본 ${base.toLocaleString('ko-KR')}원 + (km × ${perKm.toLocaleString('ko-KR')}원) + (경유 ${perStop.toLocaleString('ko-KR')}원/개)${minFee>0?` / 최소 ${minFee.toLocaleString('ko-KR')}원`:''}`,
        `💸 예상 간선비: ${cost.toLocaleString('ko-KR')}원`
      ].join('\n');
      document.getElementById('slackText').textContent = details;
    }

    // Copy to clipboard
    document.getElementById('copyBtn').addEventListener('click', () => {
      const text = document.getElementById('slackText').textContent;
      navigator.clipboard.writeText(text).then(() => {
        document.getElementById('copyBtn').textContent = '복사됨 ✅';
        setTimeout(()=> document.getElementById('copyBtn').textContent = '메시지 복사', 1200);
      }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        document.getElementById('copyBtn').textContent = '복사됨 ✅';
        setTimeout(()=> document.getElementById('copyBtn').textContent = '메시지 복사', 1200);
      });
    });

    // Inputs change -> recalc
    ['baseFee','perKm','perStop','minFee'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderCost);
    });

    // Initial render
    renderSavedLocations();
    renderSlack();
    updateAddWaypointButton();
  </script>
</body>
</html>
