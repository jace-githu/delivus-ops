<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>딜리래빗 간선비용 계산기</title>
  
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --border: #e6e8f0;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #6366f1;
      --saved: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --success: #22c55e;
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; 
      background: var(--bg); 
      color: var(--text); 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; 
    }
    
    header { 
      padding: 16px 20px; 
      border-bottom: 1px solid var(--border); 
      background: var(--panel); 
      position: sticky; 
      top: 0; 
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    header .title { 
      font-size: 18px; 
      font-weight: 700; 
      color: var(--brand);
    }
    
    .container { 
      display: grid; 
      grid-template-columns: 400px 1fr; 
      gap: 16px; 
      padding: 16px; 
      height: calc(100vh - 70px); 
    }
    
    .panel { 
      background: var(--panel); 
      border: 1px solid var(--border); 
      border-radius: 16px; 
      padding: 16px; 
      overflow-y: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .panel h3 { 
      margin: 0 0 12px; 
      font-size: 15px; 
      color: var(--text); 
      font-weight: 700; 
      letter-spacing: .02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control { margin-bottom: 12px; }
    .control label { 
      display: block; 
      font-size: 13px; 
      color: var(--muted); 
      margin-bottom: 6px;
      font-weight: 500;
    }
    .control input { 
      width: 100%; 
      padding: 12px 14px; 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .control input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    
    .btn { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      gap: 6px; 
      padding: 12px 16px; 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      background: #fff; 
      cursor: pointer; 
      font-weight: 600; 
      font-size: 13px; 
      transition: all 0.2s;
      text-decoration: none;
    }
    .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn.success { background: var(--saved); color: #fff; border-color: var(--saved); }
    .btn.warning { background: var(--warning); color: #fff; border-color: var(--warning); }
    .btn.danger { background: var(--danger); color: #fff; border-color: var(--danger); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }
    .btn:hover:not(:disabled) { 
      opacity: 0.9; 
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .hint { 
      font-size: 12px; 
      color: var(--muted); 
      margin-bottom: 10px;
      padding: 8px 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 3px solid var(--brand);
    }
    
    #map { 
      width: 100%; 
      height: 100%; 
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .kpi { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 10px; 
      margin: 16px 0;
    }
    .kpi .card { 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 16px; 
      background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
      text-align: center;
    }
    .kpi .label { 
      font-size: 12px; 
      color: var(--muted); 
      margin-bottom: 8px;
      font-weight: 500;
    }
    .kpi .value { 
      font-size: 20px; 
      font-weight: 800;
      color: var(--brand);
    }
    
    .slack { 
      border: 1px dashed var(--border); 
      border-radius: 12px; 
      padding: 14px; 
      background: #fafbff;
    }
    .small { font-size: 12px; color: var(--muted); }
    .waypoints { 
      font-size: 13px; 
      margin: 10px 0; 
      color: #374151;
      max-height: 120px;
      overflow-y: auto;
    }
    .waypoints code { 
      background: #f3f4f6; 
      border: 1px solid #e5e7eb; 
      border-radius: 6px; 
      padding: 3px 8px;
      font-size: 12px;
    }
    
    .search-container { position: relative; }
    .search-results { 
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0; 
      background: white; 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      max-height: 240px; 
      overflow-y: auto; 
      z-index: 1000; 
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      margin-top: 4px;
    }
    .search-result { 
      padding: 12px 16px; 
      cursor: pointer; 
      border-bottom: 1px solid var(--border); 
      font-size: 13px;
      transition: background-color 0.2s;
    }
    .search-result:hover { background: #f8fafc; }
    .search-result:last-child { border-bottom: none; }
    
    .saved-locations { margin-top: 12px; }
    .saved-location { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 12px 14px; 
      margin-bottom: 8px; 
      background: #f8fafc; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      font-size: 13px;
      transition: all 0.2s;
    }
    .saved-location:hover {
      background: #f1f5f9;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .saved-location .name { font-weight: 600; }
    .saved-location .info { 
      font-size: 11px; 
      color: var(--muted); 
      margin-top: 3px;
    }
    .saved-location .actions { 
      display: flex; 
      gap: 6px;
    }
    .saved-location .btn { 
      padding: 6px 10px; 
      font-size: 11px;
      min-width: 32px;
    }
    
    .location-selector { margin-bottom: 12px; }
    .location-dropdown { 
      width: 100%; 
      padding: 12px 14px; 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      font-size: 13px; 
      background: white;
      transition: border-color 0.2s;
    }
    .location-dropdown:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .sync-status { 
      padding: 12px 14px; 
      border-radius: 12px; 
      font-size: 12px; 
      margin-bottom: 12px; 
      display: flex; 
      align-items: center; 
      gap: 8px;
      font-weight: 500;
    }
    .sync-status.syncing { background: #fef3c7; color: #92400e; border: 1px solid #f59e0b; }
    .sync-status.synced { background: #d1fae5; color: #166534; border: 1px solid #10b981; }
    .sync-status.error { background: #fee2e2; color: #dc2626; border: 1px solid #ef4444; }
    .sync-status.info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }

    .loading-state { 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      height: 100%; 
      flex-direction: column; 
      color: #666;
    }
    .spinner { 
      animation: spin 1s linear infinite; 
      font-size: 32px; 
      margin-bottom: 16px;
    }
    @keyframes spin { 
      0% { transform: rotate(0deg);} 
      100% { transform: rotate(360deg);} 
    }

    .distance-note { 
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); 
      border: 1px solid #f59e0b; 
      border-radius: 10px; 
      padding: 12px; 
      margin-top: 12px; 
      font-size: 12px; 
      color: #92400e;
      line-height: 1.4;
    }

    .toggle-section { margin: 20px 0; }
    .toggle-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 14px 16px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.3s ease;
    }
    .toggle-header:hover { 
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .toggle-header h3 { 
      margin: 0; 
      font-size: 14px; 
      color: var(--text); 
      font-weight: 700;
      display: flex; 
      align-items: center; 
      gap: 8px;
    }
    .toggle-arrow { 
      transition: transform 0.3s ease; 
      font-size: 14px; 
      color: var(--muted);
    }
    .toggle-arrow.expanded { transform: rotate(180deg); }
    .toggle-content { 
      display: none;
      padding-top: 12px;
      animation: slideDown 0.3s ease;
    }
    .toggle-content.expanded { 
      display: block;
    }
    .toggle-content .saved-locations {
      max-height: 320px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .mode-selector { 
      margin-bottom: 16px; 
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 14px;
    }
    .mode-buttons { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 8px; 
      margin-top: 10px;
    }
    .mode-btn { 
      padding: 12px 16px; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      background: white; 
      cursor: pointer; 
      font-size: 12px; 
      font-weight: 600; 
      text-align: center; 
      transition: all 0.2s;
    }
    .mode-btn.active { 
      background: var(--brand); 
      color: white; 
      border-color: var(--brand);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    .mode-btn:hover:not(.active) { 
      background: #f1f5f9;
      transform: translateY(-1px);
    }

    .current-selection {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      border: 1px solid #0284c7;
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
      font-size: 12px;
    }
    .current-selection .label {
      color: #0369a1;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .current-selection .value {
      color: #0c4a6e;
      font-weight: 500;
    }

    @media (max-width: 768px) {
      .container { 
        grid-template-columns: 1fr; 
        grid-template-rows: auto 1fr; 
        height: auto; 
        min-height: calc(100vh - 70px);
        gap: 12px;
        padding: 12px;
      }
      .panel:first-child { order: 2; }
      #map { height: 400px; }
      .row { grid-template-columns: 1fr; gap: 8px; }
      .kpi { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">딜리래빗 간선비용 계산기</div>
  </header>

  <div class="container">
    <section class="panel" id="panel">
      <div id="syncStatus" class="sync-status info">
        <span>📋</span>
        <span>팀 공유 위치 자동 로드 중...</span>
      </div>

      <h3>위치 검색 및 저장</h3>
      <div class="control search-container">
        <label>위치 검색 (주소, 건물명, 랜드마크 등)</label>
        <input type="text" id="searchInput" placeholder="예: 강남역, 서울시 강남구 테헤란로 152">
        <div class="search-results" id="searchResults" style="display: none;"></div>
      </div>
      <div class="hint">검색 후 결과를 클릭하면 지도에 표시됩니다. 저장하면 모든 팀원이 볼 수 있습니다.</div>
      
      <div class="control">
        <button class="btn success" id="saveLocationBtn" disabled>위치 저장 및 팀 공유</button>
      </div>

      <div class="toggle-section">
        <div class="toggle-header" id="toggleHeader">
          <h3>저장된 핀 <button class="btn" id="refreshBtn" style="padding: 6px 10px; font-size: 11px;" onclick="event.stopPropagation();">새로고침</button></h3>
          <span class="toggle-arrow" id="toggleArrow">▼</span>
        </div>
        <div class="toggle-content" id="toggleContent">
          <div class="saved-locations" id="savedLocations">
            <div class="hint">저장된 위치가 없습니다.</div>
          </div>
        </div>
      </div>

      <h3>경로 설정</h3>
      
      <div class="mode-selector">
        <div class="hint"><strong>설정 방법 선택:</strong></div>
        <div class="mode-buttons">
          <div class="mode-btn active" id="pinMode">핀 클릭</div>
          <div class="mode-btn" id="mapMode">지도 클릭</div>
        </div>
      </div>

      <div class="current-selection" id="currentSelection">
        <div class="label">다음 설정할 위치:</div>
        <div class="value" id="nextAction">출발지를 선택하세요</div>
      </div>
      
      <div class="location-selector">
        <label>출발지 선택</label>
        <select class="location-dropdown" id="startSelect">
          <option value="">선택하세요</option>
        </select>
      </div>
      
      <div class="location-selector">
        <label>도착지 선택</label>
        <select class="location-dropdown" id="endSelect">
          <option value="">선택하세요</option>
        </select>
      </div>

      <div class="control">
        <div class="row3">
          <button class="btn" id="addWaypointBtn">경유지 추가</button>
          <button class="btn" id="undoBtn">되돌리기</button>
          <button class="btn danger" id="resetBtn">초기화</button>
        </div>
      </div>

      <h3>단가 모델</h3>
      <div class="row">
        <div class="control">
          <label>기본 요금(₩)</label>
          <input type="number" id="baseFee" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>KM 단가(₩/km)</label>
          <input type="number" id="perKm" value="1000" min="0" step="10">
        </div>
      </div>
      <div class="row">
        <div class="control">
          <label>경유지 추가요금(₩/개)</label>
          <input type="number" id="perStop" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>도로거리 보정계수</label>
          <input type="number" id="roadFactor" value="1.3" min="1" max="2" step="0.1">
        </div>
      </div>
      <div class="control">
        <label>최소 요금(₩, 선택사항)</label>
        <input type="number" id="minFee" value="0" min="0" step="100">
      </div>

      <div class="kpi">
        <div class="card">
          <div class="label">총 거리 (보정 후)</div>
          <div class="value"><span id="km">0.0</span> km</div>
        </div>
        <div class="card">
          <div class="label">예상 간선비</div>
          <div class="value">₩ <span id="cost">0</span></div>
        </div>
      </div>

      <div class="distance-note">
        <strong>거리 계산 방식:</strong> 직선거리 × 도로거리 보정계수<br>
        보정계수 1.3은 일반적인 도시 도로의 우회율을 반영합니다.
      </div>

      <h3>경유지 목록</h3>
      <div class="waypoints" id="wpList">경로를 설정하면 여기에 순서가 표시됩니다.</div>

      <h3>슬랙 공유</h3>
      <div class="slack">
        <div class="small">메시지 미리보기</div>
        <pre id="slackText" style="white-space: pre-wrap; margin:10px 0; font-size: 12px;"></pre>
        <button class="btn primary" id="copyBtn">메시지 복사</button>
      </div>
    </section>

    <section class="panel">
      <div id="map"></div>
    </section>
  </div>

  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=961ad1fa29e637215fcfab22903bfbb5&libraries=services"></script>
  
  <script>
    const PINS_API = 'https://script.google.com/macros/s/AKfycbzsbM_4tZZ5yZ5TXGLHyOe5Q6ktIv9RWO50_Nl2pj5uEIJFMgLZ9vCSobCX0vnc3XDrFg/exec';

    let savedLocations = [];
    let currentSearchResult = null;
    let map, ps, geocoder;
    let waypoints = [];
    let markers = [];
    let savedLocationMarkers = new Map();
    let waypointMode = 'auto';
    let polyline = null;
    let currentMode = 'pin';
    let isToggleOpen = false;

    function initToggle() {
      const toggleHeader = document.getElementById('toggleHeader');
      const toggleContent = document.getElementById('toggleContent');
      const toggleArrow = document.getElementById('toggleArrow');

      toggleHeader.addEventListener('click', function() {
        isToggleOpen = !isToggleOpen;
        
        if (isToggleOpen) {
          toggleContent.classList.add('expanded');
          toggleArrow.classList.add('expanded');
        } else {
          toggleContent.classList.remove('expanded');
          toggleArrow.classList.remove('expanded');
        }
      });
    }

    function initModeSelector() {
      const pinModeBtn = document.getElementById('pinMode');
      const mapModeBtn = document.getElementById('mapMode');

      pinModeBtn.addEventListener('click', () => {
        currentMode = 'pin';
        pinModeBtn.classList.add('active');
        mapModeBtn.classList.remove('active');
        updateNextActionText();
      });

      mapModeBtn.addEventListener('click', () => {
        currentMode = 'map';
        mapModeBtn.classList.add('active');
        pinModeBtn.classList.remove('active');
        updateNextActionText();
      });

      updateNextActionText();
    }

    function updateNextActionText() {
      const nextAction = document.getElementById('nextAction');
      const waypointCount = waypoints.length;
      
      if (waypointCount === 0) {
        nextAction.textContent = currentMode === 'pin' ? 
          '저장된 핀을 클릭하여 출발지 설정' : 
          '지도를 클릭하여 출발지 설정';
      } else if (waypointCount === 1) {
        nextAction.textContent = currentMode === 'pin' ? 
          '저장된 핀을 클릭하여 도착지 설정' : 
          '지도를 클릭하여 도착지 설정';
      } else if (waypointMode === 'waypoint') {
        nextAction.textContent = currentMode === 'pin' ? 
          '저장된 핀을 클릭하여 경유지 설정' : 
          '지도를 클릭하여 경유지 설정';
      } else {
        nextAction.textContent = '경로 설정 완료';
      }
    }

    async function loadFromSheet() {
      updateSyncStatus('syncing', '팀 데이터 로드 중...');
      try {
        const res = await fetch(PINS_API + '?action=list', { method: 'GET' });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        savedLocations = data.locations || [];
        updateSyncStatus('synced', `팀 데이터 로드 완료 (${savedLocations.length}개 위치)`);
        renderSavedLocations();
        updateLocationDropdowns();
        displaySavedLocationMarkers();
      } catch (err) {
        console.error('Sheet 로드 오류:', err);
        updateSyncStatus('error', '팀 공유 데이터 로드 실패');
      }
    }

    function updateSyncStatus(status, text) {
      const syncStatus = document.getElementById('syncStatus');
      syncStatus.className = 'sync-status ' + status;
      syncStatus.style.display = 'flex';

      let icon = '📋';
      switch(status) {
        case 'syncing': icon = '🔄'; break;
        case 'synced':  icon = '✅'; setTimeout(()=>{ syncStatus.style.display='none'; }, 3000); break;
        case 'error':   icon = '❌'; break;
        case 'info':    icon = 'ℹ️'; setTimeout(()=>{ syncStatus.style.display='none'; }, 5000); break;
      }
      syncStatus.innerHTML = `<span>${icon}</span><span>${text}</span>`;
    }

    function initMap() {
      try {
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 8 };
        map = new kakao.maps.Map(container, options);
        ps = new kakao.maps.services.Places();
        geocoder = new kakao.maps.services.Geocoder();

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
          if (currentMode !== 'map') return;
          
          const latlng = mouseEvent.latLng;
          if (waypointMode === 'waypoint') {
            if (waypoints.length >= 2) {
              addWaypoint(latlng);
              waypointMode = 'auto';
              updateAddWaypointButton();
            }
          } else {
            if (waypoints.length < 2) addWaypoint(latlng);
          }
        });

        console.log('카카오맵 초기화 완료');
        loadFromSheet();

      } catch (error) {
        console.error('카카오맵 초기화 오류:', error);
        document.getElementById('map').innerHTML = `
          <div class="loading-state">
            <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
            <h3 style="color: #dc2626;">지도 로드 실패</h3>
            <p style="text-align: center; color: #666;">API 키를 확인하거나 페이지를 새로고침해주세요.</p>
            <button class="btn" onclick="location.reload()">새로고침</button>
          </div>
        `;
      }
    }

    window.addEventListener('DOMContentLoaded', function() {
      initToggle();
      initModeSelector();
      
      if (typeof kakao !== 'undefined' && kakao.maps) {
        initMap();
      } else {
        document.getElementById('map').innerHTML = `
          <div class="loading-state">
            <div class="spinner">⏳</div>
            <p>카카오맵을 로드하는 중...</p>
          </div>
        `;
        let attempts = 0;
        const checkInterval = setInterval(() => {
          attempts++;
          if (typeof kakao !== 'undefined' && kakao.maps) {
            clearInterval(checkInterval);
            initMap();
          } else if (attempts > 50) {
            clearInterval(checkInterval);
            document.getElementById('map').innerHTML = `
              <div class="loading-state">
                <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                <h3 style="color: #dc2626;">API 키 설정 필요</h3>
                <p style="text-align: center; color: #666;">카카오맵 API 키를 설정해야 합니다.</p>
              </div>
            `;
          }
        }, 100);
      }
    });

    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const saveLocationBtn = document.getElementById('saveLocationBtn');

    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      if (query.length < 2) { searchResults.style.display = 'none'; return; }
      searchTimeout = setTimeout(() => searchLocation(query), 300);
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        searchResults.style.display = 'none';
      }
    });

    function searchLocation(query) {
      if (!ps) {
        searchResults.innerHTML = '<div class="search-result" style="color: #dc2626;">검색 서비스가 초기화되지 않았습니다.</div>';
        searchResults.style.display = 'block';
        return;
      }
      searchResults.innerHTML = '<div class="search-result">검색 중...</div>';
      searchResults.style.display = 'block';

      ps.keywordSearch(query, function(data, status) {
        if (status === kakao.maps.services.Status.OK && data.length > 0) {
          displaySearchResults(data.slice(0, 5));
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
          searchResults.innerHTML = '<div class="search-result">검색 결과가 없습니다. 다른 키워드로 시도해보세요.</div>';
          searchResults.style.display = 'block';
        } else {
          searchResults.innerHTML = '<div class="search-result" style="color: #dc2626;">검색 중 오류가 발생했습니다.</div>';
          searchResults.style.display = 'block';
        }
      });
    }

    function displaySearchResults(results) {
      searchResults.innerHTML = results.map(place => 
        `<div class="search-result" data-lat="${place.y}" data-lng="${place.x}" data-name="${place.place_name}" data-address="${place.address_name}">
          <div style="font-weight: 500;">${place.place_name}</div>
          <div style="font-size: 11px; color: #666; margin-top: 2px;">${place.address_name}</div>
        </div>`
      ).join('');
      searchResults.style.display = 'block';
    }

    searchResults.addEventListener('click', (e) => {
      const result = e.target.closest('.search-result');
      if (!result || !result.dataset.lat) return;

      const lat = parseFloat(result.dataset.lat);
      const lng = parseFloat(result.dataset.lng);
      const name = result.dataset.name;
      const address = result.dataset.address;

      if (currentSearchResult?.marker) currentSearchResult.marker.setMap(null);

      const markerPosition = new kakao.maps.LatLng(lat, lng);
      const marker = new kakao.maps.Marker({ position: markerPosition, map: map });

      const infowindow = new kakao.maps.InfoWindow({
        content: `<div style="padding: 8px; font-size: 12px; white-space: nowrap;">${name}<br><small style="color: #666;">검색 결과</small></div>`
      });
      infowindow.open(map, marker);

      currentSearchResult = { 
        lat, 
        lng, 
        name: name + ' (' + address + ')',
        marker,
        infowindow
      };
      map.setCenter(markerPosition);
      map.setLevel(3);
      searchResults.style.display = 'none';
      searchInput.value = name;
      saveLocationBtn.disabled = false;
    });

    saveLocationBtn.addEventListener('click', saveLocationToTeam);

    function slugify(s) {
      return (s || '')
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[\s]+/g, '-')
        .replace(/[^a-z0-9\-가-힣]/g, '')
        .slice(0, 40);
    }

    async function saveLocationToTeam() {
      if (!currentSearchResult) {
        alert('먼저 검색 후 지점을 선택하세요.');
        return;
      }
      const defaultName = currentSearchResult.name?.split(' (')[0] || '장소';
      const custom = prompt('저장할 이름을 입력하세요', defaultName);
      const finalName = (custom && custom.trim()) ? custom.trim() : defaultName;

      const id = `${slugify(finalName)}-${Math.round(currentSearchResult.lat*1e5)}-${Math.round(currentSearchResult.lng*1e5)}`;

      const form = new URLSearchParams();
      form.set('action', 'add');
      form.set('id', id);
      form.set('name', finalName);
      form.set('lat', String(currentSearchResult.lat));
      form.set('lng', String(currentSearchResult.lng));
      form.set('createdBy', '공용');

      try {
        const res = await fetch(PINS_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString()
        });
        if (!res.ok) throw new Error(await res.text());
        updateSyncStatus('synced', '팀 위치가 저장되었습니다. 목록을 갱신합니다.');
        saveLocationBtn.disabled = true;
        
        if (currentSearchResult.marker) currentSearchResult.marker.setMap(null);
        if (currentSearchResult.infowindow) currentSearchResult.infowindow.close();
        currentSearchResult = null;
        searchInput.value = '';
        
        await loadFromSheet();
      } catch (e) {
        console.error('저장 오류:', e);
        updateSyncStatus('error', '저장 실패: 잠시 후 다시 시도해주세요.');
      }
    }

    async function deleteLocation(id) {
      const target = savedLocations.find(l => l.id === id);
      if (!target) return;
      if (!confirm(`'${target.name}' 핀을 삭제할까요?`)) return;

      const form = new URLSearchParams();
      form.set('action', 'delete');
      form.set('id', id);

      try {
        const res = await fetch(PINS_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString()
        });
        if (!res.ok) throw new Error(await res.text());
        updateSyncStatus('synced', '삭제 완료. 목록을 새로 고칩니다.');
        await loadFromSheet();
      } catch (e) {
        console.error('삭제 오류:', e);
        updateSyncStatus('error', '삭제 실패: 잠시 후 다시 시도해주세요.');
      }
    }

    function addSavedLocationMarker(location) {
      if (!map) return;
      
      const markerPosition = new kakao.maps.LatLng(location.lat, location.lng);
      
      const overlay = new kakao.maps.CustomOverlay({
        position: markerPosition,
        content: `<div style="
          background: #10b981; 
          border: 2px solid white; 
          border-radius: 50%; 
          width: 20px; 
          height: 20px; 
          display: flex; 
          align-items: center; 
          justify-content: center; 
          font-size: 12px; 
          color: white;
          font-weight: bold;
          box-shadow: 0 2px 6px rgba(0,0,0,0.3);
          cursor: pointer;
        " data-location-id="${location.id}">●</div>`,
        yAnchor: 0.5,
        xAnchor: 0.5
      });
      overlay.setMap(map);

      const infowindow = new kakao.maps.InfoWindow({
        content: `<div style="padding: 10px; font-size: 13px; white-space: nowrap; text-align: center;">
          <strong>${location.name}</strong><br>
          <small style="color: #666;">클릭하여 경로에 추가</small>
        </div>`
      });

      setTimeout(() => {
        const overlayElement = document.querySelector(`[data-location-id="${location.id}"]`);
        if (overlayElement) {
          overlayElement.addEventListener('click', () => {
            handleSavedLocationClick(location);
          });
          
          overlayElement.addEventListener('mouseenter', () => {
            infowindow.setPosition(markerPosition);
            infowindow.open(map);
          });
          
          overlayElement.addEventListener('mouseleave', () => {
            infowindow.close();
          });
        }
      }, 100);

      savedLocationMarkers.set(location.id, { overlay, infowindow });
    }

    function handleSavedLocationClick(location) {
      if (currentMode !== 'pin') return;

      const latlng = new kakao.maps.LatLng(location.lat, location.lng);
      
      if (waypointMode === 'waypoint') {
        if (waypoints.length >= 2) {
          addWaypoint(latlng, location.name);
          waypointMode = 'auto';
          updateAddWaypointButton();
        }
      } else {
        if (waypoints.length < 2) {
          addWaypoint(latlng, location.name);
        }
      }
    }

    function displaySavedLocationMarkers() {
      savedLocationMarkers.forEach(({ overlay, infowindow }) => {
        if (overlay) overlay.setMap(null);
        if (infowindow) infowindow.close();
      });
      savedLocationMarkers.clear();
      
      savedLocations.forEach(location => addSavedLocationMarker(location));
    }

    function renderSavedLocations() {
      const container = document.getElementById('savedLocations');
      if (savedLocations.length === 0) {
        container.innerHTML = '<div class="hint">저장된 위치가 없습니다.</div>';
        return;
      }
      container.innerHTML = savedLocations.map(loc => {
        const createdAt = loc.createdAt ? new Date(loc.createdAt).toLocaleDateString('ko-KR') : '';
        const createdBy = loc.createdBy || '팀원';
        return `<div class="saved-location">
          <div>
            <div class="name">${loc.name}</div>
            <div class="info">추가: ${createdBy} (${createdAt})</div>
          </div>
          <div class="actions">
            <button class="btn" onclick="focusLocation('${loc.id}')" title="지도에서 찾기">찾기</button>
            <button class="btn" onclick="addLocationToRoute('${loc.id}')" title="경로에 추가">추가</button>
            <button class="btn danger" onclick="deleteLocation('${loc.id}')" title="삭제">삭제</button>
          </div>
        </div>`;
      }).join('');
    }

    function updateLocationDropdowns() {
      const startSelect = document.getElementById('startSelect');
      const endSelect = document.getElementById('endSelect');
      const options = savedLocations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('');
      startSelect.innerHTML = '<option value="">선택하세요</option>' + options;
      endSelect.innerHTML = '<option value="">선택하세요</option>' + options;
    }

    window.focusLocation = (id) => {
      const location = savedLocations.find(loc => loc.id === id);
      if (location && map) {
        map.setCenter(new kakao.maps.LatLng(location.lat, location.lng));
        map.setLevel(3);
        
        const markerInfo = savedLocationMarkers.get(id);
        if (markerInfo && markerInfo.infowindow) {
          markerInfo.infowindow.open(map);
          setTimeout(() => markerInfo.infowindow.close(), 2000);
        }
      }
    };

    window.addLocationToRoute = (id) => {
      const location = savedLocations.find(loc => loc.id === id);
      if (!location) return;
      
      const latlng = new kakao.maps.LatLng(location.lat, location.lng);
      
      if (waypointMode === 'waypoint') {
        if (waypoints.length >= 2) {
          addWaypoint(latlng, location.name);
          waypointMode = 'auto';
          updateAddWaypointButton();
        }
      } else {
        if (waypoints.length < 2) {
          addWaypoint(latlng, location.name);
        } else {
          waypointMode = 'waypoint';
          addWaypoint(latlng, location.name);
          waypointMode = 'auto';
          updateAddWaypointButton();
        }
      }
    };

    document.getElementById('startSelect').addEventListener('change', updateRoute);
    document.getElementById('endSelect').addEventListener('change', updateRoute);

    function updateRoute() {
      const startId = document.getElementById('startSelect').value;
      const endId = document.getElementById('endSelect').value;
      if (!startId || !endId) return;
      const start = savedLocations.find(loc => loc.id === startId);
      const end = savedLocations.find(loc => loc.id === endId);
      if (start && end && map) {
        resetRoute();
        addWaypoint(new kakao.maps.LatLng(start.lat, start.lng), start.name);
        addWaypoint(new kakao.maps.LatLng(end.lat, end.lng), end.name);
      }
    }

    function addWaypoint(latlng, customName = null) {
      waypoints.push(latlng);
      if (map) {
        const marker = new kakao.maps.Marker({ position: latlng, map: map });
        const label = customName || ((waypoints.length === 1) ? '출발' : (waypoints.length === 2) ? '도착' : ('경유 ' + (waypoints.length-2)));
        const color = waypoints.length === 1 ? '#22c55e' : waypoints.length === 2 ? '#ef4444' : '#f59e0b';
        
        const overlay = new kakao.maps.CustomOverlay({
          position: latlng,
          content: `<div style="background: ${color}; color: white; padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: bold; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">${label}</div>`,
          yAnchor: 2, 
          xAnchor: 0.5
        });
        overlay.setMap(map);
        markers.push({ marker, overlay });
      }
      if (waypoints.length >= 2) calculateRoute();
      renderWpList();
      updateNextActionText();
    }

    function calculateRoute() {
      if (waypoints.length < 2) return;
      let totalDistance = 0;
      const path = [];
      for (let i = 0; i < waypoints.length; i++) {
        path.push(waypoints[i]);
        if (i > 0) {
          const prevLatLng = waypoints[i-1];
          const currLatLng = waypoints[i];
          const distance = getDistanceFromLatLonInKm(
            prevLatLng.getLat(), prevLatLng.getLng(),
            currLatLng.getLat(), currLatLng.getLng()
          );
          totalDistance += distance;
        }
      }
      if (polyline) polyline.setMap(null);
      if (map) {
        polyline = new kakao.maps.Polyline({
          path: path, 
          strokeWeight: 8, 
          strokeColor: '#6366f1', 
          strokeOpacity: 0.8,
          strokeStyle: 'solid'
        });
        polyline.setMap(map);
      }
      const roadFactor = getNumber('roadFactor');
      const adjustedDistance = totalDistance * roadFactor;
      document.getElementById('km').textContent = adjustedDistance.toFixed(1);
      renderCost();
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2-lat1);
      const dLon = deg2rad(lon2-lon1); 
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      const d = R * c;
      return d;
    }
    
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function resetRoute() {
      waypoints = [];
      markers.forEach(m => {
        if (m.marker) m.marker.setMap(null);
        if (m.overlay) m.overlay.setMap(null);
      });
      markers = [];
      if (polyline) { polyline.setMap(null); polyline = null; }
      document.getElementById('km').textContent = '0.0';
      waypointMode = 'auto';
      updateAddWaypointButton();
      updateNextActionText();
      renderWpList();
      renderCost();
    }

    function updateAddWaypointButton() {
      const btn = document.getElementById('addWaypointBtn');
      if (waypointMode === 'waypoint') {
        btn.textContent = '경유지 추가 모드 ON';
        btn.classList.add('warning');
      } else {
        btn.textContent = '경유지 추가';
        btn.classList.remove('warning');
      }
    }

    document.getElementById('addWaypointBtn').addEventListener('click', () => {
      if (waypoints.length < 2) { 
        alert('먼저 출발지와 도착지를 설정해주세요.'); 
        return; 
      }
      waypointMode = 'waypoint';
      updateAddWaypointButton();
      updateNextActionText();
    });

    document.getElementById('undoBtn').addEventListener('click', () => {
      if (waypoints.length === 0) return;
      const m = markers.pop();
      if (m) {
        if (m.marker) m.marker.setMap(null);
        if (m.overlay) m.overlay.setMap(null);
      }
      waypoints.pop();
      if (waypoints.length >= 2) calculateRoute();
      else if (polyline) { polyline.setMap(null); polyline = null; }
      waypointMode = 'auto';
      updateAddWaypointButton();
      updateNextActionText();
      renderWpList();
      renderCost();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      resetRoute();
      document.getElementById('startSelect').value = '';
      document.getElementById('endSelect').value = '';
    });

    async function renderWpList() {
      const el = document.getElementById('wpList');
      if (waypoints.length === 0) {
        el.textContent = '경로를 설정하면 여기에 순서가 표시됩니다.';
        renderSlack();
        return;
      }
      const names = await Promise.all(waypoints.map((latlng, idx) => reverseName(latlng, idx)));
      el.innerHTML = names.map((n,i)=> `<div style="margin-bottom: 6px;"><strong>${i===0?'출발':(i===1?'도착':'경유 '+(i-1))}</strong>: <code>${n}</code></div>`).join('');
      renderSlack(names);
    }

    async function reverseName(latlng, idx) {
      return new Promise((resolve) => {
        if (!geocoder) {
          resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          return;
        }
        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), (result, status) => {
          if (status === kakao.maps.services.Status.OK) {
            const address = result[0];
            if (address.road_address) resolve(address.road_address.address_name);
            else if (address.address) resolve(address.address.address_name);
            else resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          } else {
            resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          }
        });
      });
    }

    function getNumber(id) { return Math.max(0, Number(document.getElementById(id).value || 0)); }

    function calcCost(km) {
      const base = getNumber('baseFee');
      const perKm = getNumber('perKm');
      const perStop = getNumber('perStop');
      const minFee = getNumber('minFee');
      const extraStops = Math.max(0, waypoints.length - 2);
      let cost = base + (km * perKm) + (extraStops * perStop);
      if (minFee > 0) cost = Math.max(cost, minFee);
      cost = Math.round(cost / 10) * 10;
      return cost;
    }

    function renderCost() {
      if (waypoints.length >= 2) {
        let totalDistance = 0;
        for (let i = 1; i < waypoints.length; i++) {
          const prevLatLng = waypoints[i-1];
          const currLatLng = waypoints[i];
          const distance = getDistanceFromLatLonInKm(
            prevLatLng.getLat(), prevLatLng.getLng(),
            currLatLng.getLat(), currLatLng.getLng()
          );
          totalDistance += distance;
        }
        const roadFactor = getNumber('roadFactor');
        const adjustedDistance = totalDistance * roadFactor;
        document.getElementById('km').textContent = adjustedDistance.toFixed(1);
      }
      
      const km = Number(document.getElementById('km').textContent) || 0;
      const cost = calcCost(km);
      document.getElementById('cost').textContent = cost.toLocaleString('ko-KR');
      renderSlack();
    }

    function renderSlack(namesOpt) {
      const km = Number(document.getElementById('km').textContent) || 0;
      const cost = calcCost(km);
      const perKm = getNumber('perKm');
      const base = getNumber('baseFee');
      const perStop = getNumber('perStop');
      const minFee = getNumber('minFee');
      const roadFactor = getNumber('roadFactor');

      let routeText = '';
      if (namesOpt && namesOpt.length > 0) {
        routeText = namesOpt.map((n,i)=> (i===0?'출발':(i===1?'도착':'경유'+(i-1))) + ': ' + n).join(' → ');
      } else {
        routeText = waypoints.map((w,i)=> (i===0?'출발':(i===1?'도착':'경유'+(i-1)))).join(' → ');
      }

      const details = [
        '딜리래빗 간선비용 견적',
        '',
        `노선: ${routeText || '경로 미설정'}`,
        `총 거리: ${km.toFixed(1)} km (보정계수 ${roadFactor})`,
        `단가 모델: 기본 ${base.toLocaleString('ko-KR')}원 + (km × ${perKm.toLocaleString('ko-KR')}원) + (경유 ${perStop.toLocaleString('ko-KR')}원/개)${minFee>0?` / 최소 ${minFee.toLocaleString('ko-KR')}원`:''}`,
        `예상 간선비: ${cost.toLocaleString('ko-KR')}원`
      ].join('\n');
      document.getElementById('slackText').textContent = details;
    }

    document.getElementById('copyBtn').addEventListener('click', () => {
      const text = document.getElementById('slackText').textContent;
      navigator.clipboard.writeText(text).then(() => {
        document.getElementById('copyBtn').textContent = '복사됨';
        setTimeout(()=> document.getElementById('copyBtn').textContent = '메시지 복사', 1500);
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        document.getElementById('copyBtn').textContent = '복사됨';
        setTimeout(()=> document.getElementById('copyBtn').textContent = '메시지 복사', 1500);
      });
    });

    ['baseFee','perKm','perStop','minFee','roadFactor'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderCost);
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadFromSheet();
    });

    renderSavedLocations();
    renderSlack();
    updateAddWaypointButton();
  </script>
</body>
</html>
