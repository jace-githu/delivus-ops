<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë”œë¦¬ë˜ë¹— ê°„ì„ ë¹„ìš© ê³„ì‚°ê¸° (ì¹´ì¹´ì˜¤ë§µ)</title>
  
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --border: #e6e8f0;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #6366f1;
      --saved: #10b981;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 10; }
    header .title { font-size: 18px; font-weight: 700; }
    .container { display: grid; grid-template-columns: 380px 1fr; gap: 14px; padding: 14px; height: calc(100vh - 66px); }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; overflow-y: auto; }
    .panel h3 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 700; letter-spacing: .02em; }
    .control { margin-bottom: 10px; }
    .control label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .control input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 9px 12px; border: 1px solid var(--border); border-radius: 10px; background:#fff; cursor: pointer; font-weight: 600; font-size: 13px; }
    .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn.success { background: var(--saved); color: #fff; border-color: var(--saved); }
    .btn.warning { background: var(--warning); color: #fff; border-color: var(--warning); }
    .btn.danger { background: #ef4444; color: #fff; border-color: #ef4444; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .hint { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    #map { width: 100%; height: 100%; border-radius: 14px; }
    .kpi { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .kpi .card { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #fff; }
    .kpi .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .value { font-size: 18px; font-weight: 800; }
    .slack { border: 1px dashed var(--border); border-radius: 10px; padding: 10px; background:#fafbff; }
    .small { font-size: 12px; color: var(--muted); }
    .waypoints { font-size: 13px; margin: 8px 0; color: #374151; }
    .waypoints code { background: #f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; }
    
    .search-container { position: relative; }
    .search-results { 
      position: absolute; top: 100%; left: 0; right: 0; background: white; 
      border: 1px solid var(--border); border-radius: 10px; max-height: 200px; 
      overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .search-result { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 13px; }
    .search-result:hover { background: #f9fafb; }
    .search-result:last-child { border-bottom: none; }
    
    .saved-locations { margin-top: 10px; }
    .saved-location { 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 8px 10px; margin-bottom: 6px; background: #f8fafc; 
      border: 1px solid var(--border); border-radius: 8px; font-size: 13px;
    }
    .saved-location .name { font-weight: 500; }
    .saved-location .info { font-size: 11px; color: var(--muted); margin-top: 2px; }
    .saved-location .actions { display: flex; gap: 4px; }
    .saved-location .btn { padding: 4px 8px; font-size: 11px; }
    
    .location-selector { margin-bottom: 10px; }
    .location-dropdown { width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 13px; background: white; }

    .sync-status { padding: 8px 10px; border-radius: 8px; font-size: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .sync-status.syncing { background: #fef3c7; color: #92400e; }
    .sync-status.synced { background: #d1fae5; color: #166534; }
    .sync-status.error { background: #fee2e2; color: #dc2626; }
    .sync-status.info { background: #dbeafe; color: #1e40af; }

    .loading-state { display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666; }
    .spinner { animation: spin 1s linear infinite; font-size: 24px; margin-bottom: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }

    .distance-note { background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 8px; margin-top: 8px; font-size: 12px; color: #92400e; }

    /* í† ê¸€ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .toggle-section { margin-top: 16px; margin-bottom: 16px; }
    .toggle-header { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 10px 12px; 
      background: #f8fafc; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      cursor: pointer; 
      transition: all 0.2s ease;
    }
    .toggle-header:hover { background: #f1f5f9; }
    .toggle-header h3 { 
      margin: 0; 
      font-size: 14px; 
      color: var(--muted); 
      font-weight: 700; 
      letter-spacing: .02em; 
      display: flex; 
      align-items: center; 
      gap: 6px;
    }
    .toggle-arrow { 
      transition: transform 0.2s ease; 
      font-size: 12px; 
      color: var(--muted);
    }
    .toggle-arrow.expanded { transform: rotate(180deg); }
    .toggle-content { 
      overflow: hidden; 
      transition: max-height 0.3s ease, opacity 0.3s ease; 
      max-height: 0; 
      opacity: 0;
    }
    .toggle-content.expanded { 
      max-height: 1000px; 
      opacity: 1; 
      padding-top: 10px;
    }

    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; grid-template-rows: auto 1fr; height: auto; min-height: calc(100vh - 66px); }
      .panel:first-child { order: 2; }
      #map { height: 400px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">ë”œë¦¬ë˜ë¹— ê°„ì„ ë¹„ìš© ê³„ì‚°ê¸° (ì¹´ì¹´ì˜¤ë§µ)</div>
  </header>

  <div class="container">
    <!-- Left Controls -->
    <section class="panel" id="panel">
      <div id="syncStatus" class="sync-status info">
        <span>ğŸ“‹</span>
        <span>íŒ€ ê³µìœ  ìœ„ì¹˜ ìë™ ë¡œë“œ ì¤‘...</span>
      </div>

      <h3>ìœ„ì¹˜ ê²€ìƒ‰ ë° ì €ì¥</h3>
      <div class="control search-container">
        <label>ìœ„ì¹˜ ê²€ìƒ‰ (ì£¼ì†Œ, ê±´ë¬¼ëª…, ëœë“œë§ˆí¬ ë“±)</label>
        <input type="text" id="searchInput" placeholder="ì˜ˆ: ê°•ë‚¨ì—­, ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 152">
        <div class="search-results" id="searchResults" style="display: none;"></div>
      </div>
      <div class="hint">ê²€ìƒ‰ í›„ ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ ì§€ë„ì— í‘œì‹œë©ë‹ˆë‹¤. ì €ì¥í•˜ë©´ ëª¨ë“  íŒ€ì›ì´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      
      <div class="control">
        <button class="btn success" id="saveLocationBtn" disabled>ìœ„ì¹˜ ì €ì¥ ë° íŒ€ ê³µìœ </button>
      </div>

      <!-- í† ê¸€ í˜•íƒœë¡œ ë³€ê²½ëœ íŒ€ ê³µìœ  ìœ„ì¹˜ ì„¹ì…˜ -->
      <div class="toggle-section">
        <div class="toggle-header" id="toggleHeader">
          <h3>íŒ€ ê³µìœ  ìœ„ì¹˜ <button class="btn" id="refreshBtn" style="padding: 4px 8px; font-size: 11px;" onclick="event.stopPropagation();">ğŸ”„</button></h3>
          <span class="toggle-arrow" id="toggleArrow">â–¼</span>
        </div>
        <div class="toggle-content" id="toggleContent">
          <div class="saved-locations" id="savedLocations">
            <div class="hint">ì €ì¥ëœ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        </div>
      </div>

      <h3>ê²½ë¡œ ì„¤ì •</h3>
      <div class="hint">
        <strong>ë°©ë²• 1:</strong> ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ì¶œë°œì§€ â†’ ë„ì°©ì§€ ìˆœì„œë¡œ ì„¤ì •<br>
        <strong>ë°©ë²• 2:</strong> ì•„ë˜ ë“œë¡­ë‹¤ìš´ì—ì„œ ì €ì¥ëœ ìœ„ì¹˜ ì„ íƒ
      </div>
      
      <div class="location-selector">
        <label>ì¶œë°œì§€ ì„ íƒ</label>
        <select class="location-dropdown" id="startSelect">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      
      <div class="location-selector">
        <label>ë„ì°©ì§€ ì„ íƒ</label>
        <select class="location-dropdown" id="endSelect">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <div class="control">
        <div class="row3">
          <button class="btn" id="addWaypointBtn">ê²½ìœ ì§€ ì¶”ê°€</button>
          <button class="btn" id="undoBtn">ë§ˆì§€ë§‰ ì œê±°</button>
          <button class="btn danger" id="resetBtn">ì´ˆê¸°í™”</button>
        </div>
      </div>

      <h3>ë‹¨ê°€ ëª¨ë¸</h3>
      <div class="row">
        <div class="control">
          <label>ê¸°ë³¸ ìš”ê¸ˆ(â‚©)</label>
          <input type="number" id="baseFee" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>KM ë‹¨ê°€(â‚©/km)</label>
          <input type="number" id="perKm" value="1000" min="0" step="10">
        </div>
      </div>
      <div class="row">
        <div class="control">
          <label>ê²½ìœ ì§€ ì¶”ê°€ìš”ê¸ˆ(â‚©/ê°œ)</label>
          <input type="number" id="perStop" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>ë„ë¡œê±°ë¦¬ ë³´ì •ê³„ìˆ˜</label>
          <input type="number" id="roadFactor" value="1.3" min="1" max="2" step="0.1">
        </div>
      </div>
      <div class="row">
        <div class="control">
          <label>ìµœì†Œ ìš”ê¸ˆ(â‚©, ì„ íƒ)</label>
          <input type="number" id="minFee" value="0" min="0" step="100">
        </div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="label">ì´ ê±°ë¦¬ (ë³´ì • í›„)</div>
          <div class="value"><span id="km">0.0</span> km</div>
        </div>
        <div class="card">
          <div class="label">ì˜ˆìƒ ê°„ì„ ë¹„</div>
          <div class="value">â‚© <span id="cost">0</span></div>
        </div>
      </div>

      <div class="distance-note">
        <strong>ê±°ë¦¬ ê³„ì‚° ë°©ì‹:</strong> ì§ì„ ê±°ë¦¬ Ã— ë„ë¡œê±°ë¦¬ ë³´ì •ê³„ìˆ˜<br>
        ë³´ì •ê³„ìˆ˜ 1.3ì€ ì¼ë°˜ì ì¸ ë„ì‹œ ë„ë¡œì˜ ìš°íšŒìœ¨ì„ ë°˜ì˜í•©ë‹ˆë‹¤.
      </div>

      <h3>ê²½ìœ ì§€</h3>
      <div class="waypoints" id="wpList">ê²½ë¡œë¥¼ ì„¤ì •í•˜ë©´ ì—¬ê¸°ì— ìˆœì„œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

      <h3>ìŠ¬ë™ ê³µìœ </h3>
      <div class="slack">
        <div class="small">ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°</div>
        <pre id="slackText" style="white-space: pre-wrap; margin:8px 0;"></pre>
        <button class="btn primary" id="copyBtn">ë©”ì‹œì§€ ë³µì‚¬</button>
      </div>
    </section>

    <!-- Map -->
    <section class="panel">
      <div id="map"></div>
    </section>
  </div>

  <!-- ì¹´ì¹´ì˜¤ë§µ API -->
  <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=961ad1fa29e637215fcfab22903bfbb5&libraries=services"></script>
  
  <script>
    // === Apps Script API (Google Sheets ì €ì¥ì†Œ) ===
    const PINS_API = 'https://script.google.com/macros/s/AKfycbzsbM_4tZZ5yZ5TXGLHyOe5Q6ktIv9RWO50_Nl2pj5uEIJFMgLZ9vCSobCX0vnc3XDrFg/exec';

    // --- Data Storage ---
    let savedLocations = [];
    let currentSearchResult = null;

    // --- Map Variables ---
    let map, ps, geocoder;
    let waypoints = [];
    let markers = [];
    let savedLocationMarkers = new Map();
    let waypointMode = 'auto';
    let polyline = null;

    // --- Toggle functionality ---
    let isToggleOpen = false;

    function initToggle() {
      const toggleHeader = document.getElementById('toggleHeader');
      const toggleContent = document.getElementById('toggleContent');
      const toggleArrow = document.getElementById('toggleArrow');

      toggleHeader.addEventListener('click', function() {
        isToggleOpen = !isToggleOpen;
        
        if (isToggleOpen) {
          toggleContent.classList.add('expanded');
          toggleArrow.classList.add('expanded');
        } else {
          toggleContent.classList.remove('expanded');
          toggleArrow.classList.remove('expanded');
        }
      });
    }

    // --- Load pins from Google Sheets via Apps Script ---
    async function loadFromSheet() {
      updateSyncStatus('syncing', 'íŒ€ ë°ì´í„° ë¡œë“œ ì¤‘...');
      try {
        const res = await fetch(PINS_API + '?action=list', { method: 'GET' });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        savedLocations = data.locations || [];
        updateSyncStatus('synced', `íŒ€ ë°ì´í„° ë¡œë“œ ì™„ë£Œ (${savedLocations.length}ê°œ ìœ„ì¹˜)`);
        renderSavedLocations();
        updateLocationDropdowns();
        displaySavedLocationMarkers();
      } catch (err) {
        console.error('Sheet ë¡œë“œ ì˜¤ë¥˜:', err);
        updateSyncStatus('error', 'íŒ€ ê³µìœ  ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
      }
    }

    function updateSyncStatus(status, text) {
      const syncStatus = document.getElementById('syncStatus');
      syncStatus.className = 'sync-status ' + status;
      syncStatus.style.display = 'flex';

      let icon = 'ğŸ“‹';
      switch(status) {
        case 'syncing': icon = 'ğŸ”„'; break;
        case 'synced':  icon = 'âœ…'; setTimeout(()=>{ syncStatus.style.display='none'; }, 3000); break;
        case 'error':   icon = 'âŒ'; break;
        case 'info':    icon = 'â„¹ï¸'; setTimeout(()=>{ syncStatus.style.display='none'; }, 5000); break;
      }
      syncStatus.innerHTML = `<span>${icon}</span><span>${text}</span>`;
    }

    // --- Map Initialization ---
    function initMap() {
      try {
        const container = document.getElementById('map');
        const options = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 8 };
        map = new kakao.maps.Map(container, options);
        ps = new kakao.maps.services.Places();
        geocoder = new kakao.maps.services.Geocoder();

        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
          const latlng = mouseEvent.latLng;
          if (waypointMode === 'waypoint') {
            if (waypoints.length >= 2) {
              addWaypoint(latlng);
              waypointMode = 'auto';
              updateAddWaypointButton();
            }
          } else {
            if (waypoints.length < 2) addWaypoint(latlng);
          }
        });

        console.log('ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì™„ë£Œ');
        loadFromSheet();

      } catch (error) {
        console.error('ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
        document.getElementById('map').innerHTML = `
          <div class="loading-state">
            <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
            <h3 style="color: #dc2626;">ì§€ë„ ë¡œë“œ ì‹¤íŒ¨</h3>
            <p style="text-align: center; color: #666;">API í‚¤ë¥¼ í™•ì¸í•˜ê±°ë‚˜ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.</p>
            <button class="btn" onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        `;
      }
    }

    // í˜ì´ì§€ ë¡œë“œ í›„ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', function() {
      initToggle(); // í† ê¸€ ì´ˆê¸°í™” ì¶”ê°€
      
      if (typeof kakao !== 'undefined' && kakao.maps) {
        initMap();
      } else {
        document.getElementById('map').innerHTML = `
          <div class="loading-state">
            <div class="spinner">â³</div>
            <p>ì¹´ì¹´ì˜¤ë§µì„ ë¡œë“œí•˜ëŠ” ì¤‘...</p>
          </div>
        `;
        let attempts = 0;
        const checkInterval = setInterval(() => {
          attempts++;
          if (typeof kakao !== 'undefined' && kakao.maps) {
            clearInterval(checkInterval);
            initMap();
          } else if (attempts > 50) {
            clearInterval(checkInterval);
            document.getElementById('map').innerHTML = `
              <div class="loading-state">
                <div style="font-size: 48px; margin-bottom: 20px;">âš ï¸</div>
                <h3 style="color: #dc2626;">API í‚¤ ì„¤ì • í•„ìš”</h3>
                <p style="text-align: center; color: #666;">ì¹´ì¹´ì˜¤ë§µ API í‚¤ë¥¼ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.</p>
              </div>
            `;
          }
        }, 100);
      }
    });

    // --- Search Functionality ---
    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const saveLocationBtn = document.getElementById('saveLocationBtn');

    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      if (query.length < 2) { searchResults.style.display = 'none'; return; }
      searchTimeout = setTimeout(() => searchLocation(query), 300);
    });

    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        searchResults.style.display = 'none';
      }
    });

    function searchLocation(query) {
      if (!ps) {
        searchResults.innerHTML = '<div class="search-result" style="color: #dc2626;">ê²€ìƒ‰ ì„œë¹„ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
        searchResults.style.display = 'block';
        return;
      }
      searchResults.innerHTML = '<div class="search-result">ê²€ìƒ‰ ì¤‘...</div>';
      searchResults.style.display = 'block';

      ps.keywordSearch(query, function(data, status) {
        if (status === kakao.maps.services.Status.OK && data.length > 0) {
          displaySearchResults(data.slice(0, 5));
        } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
          searchResults.innerHTML = '<div class="search-result">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ì‹œë„í•´ë³´ì„¸ìš”.</div>';
          searchResults.style.display = 'block';
        } else {
          searchResults.innerHTML = '<div class="search-result" style="color: #dc2626;">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
          searchResults.style.display = 'block';
        }
      });
    }

    function displaySearchResults(results) {
      searchResults.innerHTML = results.map(place => 
        `<div class="search-result" data-lat="${place.y}" data-lng="${place.x}" data-name="${place.place_name}" data-address="${place.address_name}">
          <div style="font-weight: 500;">${place.place_name}</div>
          <div style="font-size: 11px; color: #666; margin-top: 2px;">${place.address_name}</div>
        </div>`
      ).join('');
      searchResults.style.display = 'block';
    }

    searchResults.addEventListener('click', (e) => {
      const result = e.target.closest('.search-result');
      if (!result || !result.dataset.lat) return;

      const lat = parseFloat(result.dataset.lat);
      const lng = parseFloat(result.dataset.lng);
      const name = result.dataset.name;
      const address = result.dataset.address;

      if (currentSearchResult?.marker) currentSearchResult.marker.setMap(null);
      if (currentSearchResult?.overlay) currentSearchResult.overlay.setMap(null);

      const markerPosition = new kakao.maps.LatLng(lat, lng);
      const marker = new kakao.maps.Marker({ position: markerPosition, map: map });

      const overlay = new kakao.maps.CustomOverlay({
        position: markerPosition,
        content: '<div style="background: #fff; border: 2px solid #ff6b6b; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px;">ğŸ”</div>',
        yAnchor: 1, xAnchor: 0.5
      });
      overlay.setMap(map);

      currentSearchResult = { 
        lat, 
        lng, 
        name: name + ' (' + address + ')',
        marker, 
        overlay 
      };
      map.setCenter(markerPosition);
      map.setLevel(3);
      searchResults.style.display = 'none';
      searchInput.value = name;
      saveLocationBtn.disabled = false;
    });

    // --- Save Location (with custom name) ---
    saveLocationBtn.addEventListener('click', saveLocationToTeam);

    function slugify(s) {
      return (s || '')
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[\s]+/g, '-')
        .replace(/[^a-z0-9\-ê°€-í£]/g, '')
        .slice(0, 40);
    }

    async function saveLocationToTeam() {
      if (!currentSearchResult) {
        alert('ë¨¼ì € ê²€ìƒ‰ í›„ ì§€ì ì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
      }
      // ì´ë¦„ ì…ë ¥(ê¸°ë³¸ê°’: ê²€ìƒ‰ ê²°ê³¼ëª…)
      const defaultName = currentSearchResult.name?.split(' (')[0] || 'ì¥ì†Œ';
      const custom = prompt('ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', defaultName);
      const finalName = (custom && custom.trim()) ? custom.trim() : defaultName;

      // id ìƒì„±: ì´ë¦„ slug + ì¢Œí‘œ í•´ì‹œ(ì¶©ëŒ ë°©ì§€)
      const id = `${slugify(finalName)}-${Math.round(currentSearchResult.lat*1e5)}-${Math.round(currentSearchResult.lng*1e5)}`;

      // x-www-form-urlencoded ë¡œ ì „ì†¡ (í”„ë¦¬í”Œë¼ì´íŠ¸ íšŒí”¼)
      const form = new URLSearchParams();
      form.set('action', 'add'); // ì„œë²„ê°€ ì—†ì–´ë„ ë¬´ì‹œ ê°€ëŠ¥
      form.set('id', id);
      form.set('name', finalName);
      form.set('lat', String(currentSearchResult.lat));
      form.set('lng', String(currentSearchResult.lng));
      form.set('createdBy', 'ê³µìš©');

      try {
        const res = await fetch(PINS_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString()
        });
        if (!res.ok) throw new Error(await res.text());
        updateSyncStatus('synced', 'íŒ€ ìœ„ì¹˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ëª©ë¡ì„ ê°±ì‹ í•©ë‹ˆë‹¤.');
        saveLocationBtn.disabled = true;
        await loadFromSheet();
      } catch (e) {
        console.error('ì €ì¥ ì˜¤ë¥˜:', e);
        updateSyncStatus('error', 'ì €ì¥ ì‹¤íŒ¨: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    // --- Delete Location ---
    async function deleteLocation(id) {
      const target = savedLocations.find(l => l.id === id);
      if (!target) return;
      if (!confirm(`'${target.name}' í•€ì„ ì‚­ì œí• ê¹Œìš”?`)) return;

      const form = new URLSearchParams();
      form.set('action', 'delete');
      form.set('id', id);

      try {
        const res = await fetch(PINS_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: form.toString()
        });
        if (!res.ok) throw new Error(await res.text());
        updateSyncStatus('synced', 'ì‚­ì œ ì™„ë£Œ. ëª©ë¡ì„ ìƒˆë¡œ ê³ ì¹©ë‹ˆë‹¤.');
        await loadFromSheet();
      } catch (e) {
        console.error('ì‚­ì œ ì˜¤ë¥˜:', e);
        updateSyncStatus('error', 'ì‚­ì œ ì‹¤íŒ¨: ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    }

    function addSavedLocationMarker(location) {
      if (!map) return;
      const markerPosition = new kakao.maps.LatLng(location.lat, location.lng);
      const marker = new kakao.maps.Marker({ position: markerPosition, map: map });
      const overlay = new kakao.maps.CustomOverlay({
        position: markerPosition,
        content: `<div style="background: #fff; border: 2px solid #10b981; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ğŸ“</div>`,
        yAnchor: 1, xAnchor: 0.5
      });
      overlay.setMap(map);

      const infowindow = new kakao.maps.InfoWindow({
        content: `<div style="padding: 5px; font-size: 12px;">${location.name}</div>`
      });
      kakao.maps.event.addListener(marker, 'mouseover', () => infowindow.open(map, marker));
      kakao.maps.event.addListener(marker, 'mouseout', () => infowindow.close());

      savedLocationMarkers.set(location.id, { marker, overlay });
    }

    function displaySavedLocationMarkers() {
      savedLocationMarkers.forEach(({ marker, overlay }) => {
        marker.setMap(null);
        overlay.setMap(null);
      });
      savedLocationMarkers.clear();
      savedLocations.forEach(location => addSavedLocationMarker(location));
    }

    function renderSavedLocations() {
      const container = document.getElementById('savedLocations');
      if (savedLocations.length === 0) {
        container.innerHTML = '<div class="hint">ì €ì¥ëœ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      container.innerHTML = savedLocations.map(loc => {
        const createdAt = loc.createdAt ? new Date(loc.createdAt).toLocaleDateString('ko-KR') : '';
        const createdBy = loc.createdBy || 'íŒ€ì›';
        return `<div class="saved-location">
          <div>
            <div class="name">${loc.name}</div>
            <div class="info">ì¶”ê°€: ${createdBy} (${createdAt})</div>
          </div>
          <div class="actions">
            <button class="btn" onclick="focusLocation('${loc.id}')">ğŸ“</button>
            <button class="btn danger" onclick="deleteLocation('${loc.id}')">ğŸ—‘</button>
          </div>
        </div>`;
      }).join('');
    }

    function updateLocationDropdowns() {
      const startSelect = document.getElementById('startSelect');
      const endSelect = document.getElementById('endSelect');
      const options = savedLocations.map(loc => `<option value="${loc.id}">${loc.name}</option>`).join('');
      startSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + options;
      endSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + options;
    }

    window.focusLocation = (id) => {
      const location = savedLocations.find(loc => loc.id === id);
      if (location && map) {
        map.setCenter(new kakao.maps.LatLng(location.lat, location.lng));
        map.setLevel(3);
      }
    };

    // --- Route Planning ---
    document.getElementById('startSelect').addEventListener('change', updateRoute);
    document.getElementById('endSelect').addEventListener('change', updateRoute);

    function updateRoute() {
      const startId = document.getElementById('startSelect').value;
      const endId = document.getElementById('endSelect').value;
      if (!startId || !endId) return;
      const start = savedLocations.find(loc => loc.id === startId);
      const end = savedLocations.find(loc => loc.id === endId);
      if (start && end && map) {
        resetRoute();
        addWaypoint(new kakao.maps.LatLng(start.lat, start.lng), start.name);
        addWaypoint(new kakao.maps.LatLng(end.lat, end.lng), end.name);
      }
    }

    function addWaypoint(latlng, customName = null) {
      waypoints.push(latlng);
      if (map) {
        const marker = new kakao.maps.Marker({ position: latlng, map: map });
        const label = customName || ((waypoints.length === 1) ? 'ì¶œë°œ' : (waypoints.length === 2) ? 'ë„ì°©' : ('ê²½ìœ  ' + (waypoints.length-2)));
        const color = waypoints.length === 1 ? '#22c55e' : waypoints.length === 2 ? '#ef4444' : '#f59e0b';
        const overlay = new kakao.maps.CustomOverlay({
          position: latlng,
          content: `<div style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap;">${label}</div>`,
          yAnchor: 2, xAnchor: 0.5
        });
        overlay.setMap(map);
        markers.push({ marker, overlay });
      }
      if (waypoints.length >= 2) calculateRoute();
      renderWpList();
    }

    function calculateRoute() {
      if (waypoints.length < 2) return;
      let totalDistance = 0;
      const path = [];
      for (let i = 0; i < waypoints.length; i++) {
        path.push(waypoints[i]);
        if (i > 0) {
          const prevLatLng = waypoints[i-1];
          const currLatLng = waypoints[i];
          const distance = getDistanceFromLatLonInKm(
            prevLatLng.getLat(), prevLatLng.getLng(),
            currLatLng.getLat(), currLatLng.getLng()
          );
          totalDistance += distance;
        }
      }
      if (polyline) polyline.setMap(null);
      if (map) {
        polyline = new kakao.maps.Polyline({
          path: path, strokeWeight: 6, strokeColor: '#6366f1', strokeOpacity: 0.8
        });
        polyline.setMap(map);
      }
      const roadFactor = getNumber('roadFactor');
      const adjustedDistance = totalDistance * roadFactor;
      document.getElementById('km').textContent = adjustedDistance.toFixed(1);
      renderCost();
    }

    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = deg2rad(lat2-lat1);
      const dLon = deg2rad(lon2-lon1); 
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      const d = R * c;
      return d;
    }
    function deg2rad(deg) { return deg * (Math.PI/180); }

    function resetRoute() {
      waypoints = [];
      markers.forEach(m => {
        if (m.marker) m.marker.setMap(null);
        if (m.overlay) m.overlay.setMap(null);
      });
      markers = [];
      if (polyline) { polyline.setMap(null); polyline = null; }
      document.getElementById('km').textContent = '0.0';
      waypointMode = 'auto';
      updateAddWaypointButton();
      renderWpList();
      renderCost();
    }

    function updateAddWaypointButton() {
      const btn = document.getElementById('addWaypointBtn');
      if (waypointMode === 'waypoint') {
        btn.textContent = 'ì§€ë„ í´ë¦­í•˜ì—¬ ê²½ìœ ì§€ ì¶”ê°€';
        btn.classList.add('warning');
      } else {
        btn.textContent = 'ê²½ìœ ì§€ ì¶”ê°€';
        btn.classList.remove('warning');
      }
    }

    document.getElementById('addWaypointBtn').addEventListener('click', () => {
      if (waypoints.length < 2) { alert('ë¨¼ì € ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.'); return; }
      waypointMode = 'waypoint';
      updateAddWaypointButton();
    });

    document.getElementById('undoBtn').addEventListener('click', () => {
      if (waypoints.length === 0) return;
      const m = markers.pop();
      if (m) {
        if (m.marker) m.marker.setMap(null);
        if (m.overlay) m.overlay.setMap(null);
      }
      waypoints.pop();
      if (waypoints.length >= 2) calculateRoute();
      else if (polyline) { polyline.setMap(null); polyline = null; }
      waypointMode = 'auto';
      updateAddWaypointButton();
      renderWpList();
      renderCost();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      resetRoute();
      document.getElementById('startSelect').value = '';
      document.getElementById('endSelect').value = '';
    });

    async function renderWpList() {
      const el = document.getElementById('wpList');
      if (waypoints.length === 0) {
        el.textContent = 'ê²½ë¡œë¥¼ ì„¤ì •í•˜ë©´ ì—¬ê¸°ì— ìˆœì„œê°€ í‘œì‹œë©ë‹ˆë‹¤.';
        renderSlack();
        return;
      }
      const names = await Promise.all(waypoints.map((latlng, idx) => reverseName(latlng, idx)));
      el.innerHTML = names.map((n,i)=> `<div>${i===0?'ì¶œë°œ':(i===1?'ë„ì°©':'ê²½ìœ  '+(i-1))}: <code>${n}</code></div>`).join('');
      renderSlack(names);
    }

    async function reverseName(latlng, idx) {
      return new Promise((resolve) => {
        if (!geocoder) {
          resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          return;
        }
        geocoder.coord2Address(latlng.getLng(), latlng.getLat(), (result, status) => {
          if (status === kakao.maps.services.Status.OK) {
            const address = result[0];
            if (address.road_address) resolve(address.road_address.address_name);
            else if (address.address) resolve(address.address.address_name);
            else resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          } else {
            resolve(`${latlng.getLat().toFixed(5)}, ${latlng.getLng().toFixed(5)}`);
          }
        });
      });
    }

    function getNumber(id) { return Math.max(0, Number(document.getElementById(id).value || 0)); }

    function calcCost(km) {
      const base = getNumber('baseFee');
      const perKm = getNumber('perKm');
      const perStop = getNumber('perStop');
      const minFee = getNumber('minFee');
      const extraStops = Math.max(0, waypoints.length - 2);
      let cost = base + (km * perKm) + (extraStops * perStop);
      if (minFee > 0) cost = Math.max(cost, minFee);
      cost = Math.round(cost / 10) * 10;
      return cost;
    }

    function renderCost() {
      const km = Number(document.getElementById('km').textContent) || 0;
      const cost = calcCost(km);
      document.getElementById('cost').textContent = cost.toLocaleString('ko-KR');
      renderSlack();
    }

    function renderSlack(namesOpt) {
      const km = Number(document.getElementById('km').textContent) || 0;
      const cost = calcCost(km);
      const perKm = getNumber('perKm');
      const base = getNumber('baseFee');
      const perStop = getNumber('perStop');
      const minFee = getNumber('minFee');
      const roadFactor = getNumber('roadFactor');

      let routeText = '';
      if (namesOpt && namesOpt.length > 0) {
        routeText = namesOpt.map((n,i)=> (i===0?'ì¶œë°œ':(i===1?'ë„ì°©':'ê²½ìœ '+(i-1))) + ': ' + n).join(' â†’ ');
      } else {
        routeText = waypoints.map((w,i)=> (i===0?'ì¶œë°œ':(i===1?'ë„ì°©':'ê²½ìœ '+(i-1)))).join(' â†’ ');
      }

      const details = [
        `ğŸ“ ë…¸ì„ : ${routeText || 'ê²½ë¡œ ë¯¸ì„¤ì •'}`,
        `ğŸ“ ì´ ê±°ë¦¬: ${km.toFixed(1)} km (ë³´ì •ê³„ìˆ˜ ${roadFactor})`,
        `ğŸ’° ë‹¨ê°€ ëª¨ë¸: ê¸°ë³¸ ${base.toLocaleString('ko-KR')}ì› + (km Ã— ${perKm.toLocaleString('ko-KR')}ì›) + (ê²½ìœ  ${perStop.toLocaleString('ko-KR')}ì›/ê°œ)${minFee>0?` / ìµœì†Œ ${minFee.toLocaleString('ko-KR')}ì›`:''}`,
        `ğŸ’¸ ì˜ˆìƒ ê°„ì„ ë¹„: ${cost.toLocaleString('ko-KR')}ì›`
      ].join('\n');
      document.getElementById('slackText').textContent = details;
    }

    document.getElementById('copyBtn').addEventListener('click', () => {
      const text = document.getElementById('slackText').textContent;
      navigator.clipboard.writeText(text).then(() => {
        document.getElementById('copyBtn').textContent = 'ë³µì‚¬ë¨ âœ…';
        setTimeout(()=> document.getElementById('copyBtn').textContent = 'ë©”ì‹œì§€ ë³µì‚¬', 1200);
      }).catch(() => {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        document.getElementById('copyBtn').textContent = 'ë³µì‚¬ë¨ âœ…';
        setTimeout(()=> document.getElementById('copyBtn').textContent = 'ë©”ì‹œì§€ ë³µì‚¬', 1200);
      });
    });

    // --- Event Listeners ---
    ['baseFee','perKm','perStop','minFee','roadFactor'].forEach(id => {
      document.getElementById(id).addEventListener('input', renderCost);
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      loadFromSheet();
    });

    // ì´ˆê¸° ë Œë”ë§
    renderSavedLocations();
    renderSlack();
    updateAddWaypointButton();
  </script>
</body>
</html>
