<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë”œë¦¬ë˜ë¹— ê°„ì„ ë¹„ìš© ê³„ì‚°ê¸°</title>
  
  <style>
    :root {
      --bg: #f7f8fb;
      --panel: #ffffff;
      --border: #e6e8f0;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #6366f1;
      --saved: #10b981;
      --warning: #f59e0b;
    }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--panel); position: sticky; top: 0; z-index: 10; }
    header .title { font-size: 18px; font-weight: 700; }
    .container { display: grid; grid-template-columns: 380px 1fr; gap: 14px; padding: 14px; height: calc(100vh - 66px); }
    .panel { background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 14px; overflow-y: auto; }
    .panel h3 { margin: 0 0 10px; font-size: 14px; color: var(--muted); font-weight: 700; letter-spacing: .02em; }
    .control { margin-bottom: 10px; }
    .control label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .control input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 14px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; padding: 9px 12px; border: 1px solid var(--border); border-radius: 10px; background:#fff; cursor: pointer; font-weight: 600; font-size: 13px; }
    .btn.primary { background: var(--brand); color: #fff; border-color: var(--brand); }
    .btn.success { background: var(--saved); color: #fff; border-color: var(--saved); }
    .btn.warning { background: var(--warning); color: #fff; border-color: var(--warning); }
    .btn.danger { background: #ef4444; color: #fff; border-color: #ef4444; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:hover:not(:disabled) { opacity: 0.9; }
    .hint { font-size: 12px; color: var(--muted); margin-bottom: 8px; }
    #map { width: 100%; height: 100%; border-radius: 14px; }
    .kpi { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .kpi .card { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #fff; }
    .kpi .label { font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .kpi .value { font-size: 18px; font-weight: 800; }
    .slack { border: 1px dashed var(--border); border-radius: 10px; padding: 10px; background:#fafbff; }
    .small { font-size: 12px; color: var(--muted); }
    .waypoints { font-size: 13px; margin: 8px 0; color: #374151; }
    .waypoints code { background: #f3f4f6; border:1px solid #e5e7eb; border-radius:6px; padding:2px 6px; }
    
    .search-container { position: relative; }
    .search-results { 
      position: absolute; 
      top: 100%; 
      left: 0; 
      right: 0; 
      background: white; 
      border: 1px solid var(--border); 
      border-radius: 10px; 
      max-height: 200px; 
      overflow-y: auto; 
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .search-result { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 13px; }
    .search-result:hover { background: #f9fafb; }
    .search-result:last-child { border-bottom: none; }
    
    .saved-locations { margin-top: 10px; }
    .saved-location { 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      padding: 8px 10px; 
      margin-bottom: 6px; 
      background: #f8fafc; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      font-size: 13px;
    }
    .saved-location .name { font-weight: 500; }
    .saved-location .actions { display: flex; gap: 4px; }
    .saved-location .btn { padding: 4px 8px; font-size: 11px; }
    
    .location-selector { margin-bottom: 10px; }
    .location-dropdown { 
      width: 100%; 
      padding: 8px 10px; 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      font-size: 13px; 
      background: white;
    }

    .api-notice {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      font-size: 13px;
      color: #856404;
    }
    
    .api-notice strong { color: #b45309; }
  </style>
</head>
<body>
  <header>
    <div class="title">ë”œë¦¬ë˜ë¹— ê°„ì„ ë¹„ìš© ê³„ì‚°ê¸° (ì¹´ì¹´ì˜¤ë§µ)</div>
  </header>

  <div class="container">
    <!-- Left Controls -->
    <section class="panel" id="panel">
      <div class="api-notice">
        <strong>âš ï¸ API í‚¤ ì„¤ì • í•„ìš”:</strong><br>
        ì¹´ì¹´ì˜¤ë§µ APIë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ <a href="https://developers.kakao.com" target="_blank">ì¹´ì¹´ì˜¤ ê°œë°œìì‚¬ì´íŠ¸</a>ì—ì„œ JavaScript í‚¤ë¥¼ ë°œê¸‰ë°›ì•„ ì•„ë˜ ì½”ë“œì˜ 'YOUR_JAVASCRIPT_KEY'ë¥¼ êµì²´í•´ì£¼ì„¸ìš”.
      </div>

      <h3>ìœ„ì¹˜ ê²€ìƒ‰ ë° ì €ì¥</h3>
      <div class="control search-container">
        <label>ìœ„ì¹˜ ê²€ìƒ‰ (ì£¼ì†Œ, ê±´ë¬¼ëª…, ëœë“œë§ˆí¬ ë“±)</label>
        <input type="text" id="searchInput" placeholder="ì˜ˆ: ê°•ë‚¨ì—­, ì„œìš¸ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 152">
        <div class="search-results" id="searchResults" style="display: none;"></div>
      </div>
      <div class="hint">ê²€ìƒ‰ í›„ ê²°ê³¼ë¥¼ í´ë¦­í•˜ë©´ ì§€ë„ì— ğŸ”ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤. ì €ì¥ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìœ„ì¹˜ë¥¼ ì˜êµ¬ ì €ì¥í•˜ì„¸ìš”.</div>
      
      <div class="control">
        <button class="btn success" id="saveLocationBtn" disabled>ğŸ“ í˜„ì¬ ìœ„ì¹˜ ì €ì¥</button>
      </div>

      <h3>ì €ì¥ëœ ìœ„ì¹˜</h3>
      <div class="saved-locations" id="savedLocations">
        <div class="hint">ì €ì¥ëœ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      </div>

      <h3>ê²½ë¡œ ì„¤ì •</h3>
      <div class="hint">
        <strong>ë°©ë²• 1:</strong> ì§€ë„ë¥¼ í´ë¦­í•´ì„œ ì¶œë°œì§€ â†’ ë„ì°©ì§€ ìˆœì„œë¡œ ì„¤ì •<br>
        <strong>ë°©ë²• 2:</strong> ì•„ë˜ ë“œë¡­ë‹¤ìš´ì—ì„œ ì €ì¥ëœ ìœ„ì¹˜ ì„ íƒ
      </div>
      
      <div class="location-selector">
        <label>ì¶œë°œì§€ ì„ íƒ</label>
        <select class="location-dropdown" id="startSelect">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      
      <div class="location-selector">
        <label>ë„ì°©ì§€ ì„ íƒ</label>
        <select class="location-dropdown" id="endSelect">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>

      <div class="control">
        <div class="row3">
          <button class="btn" id="addWaypointBtn">ê²½ìœ ì§€ ì¶”ê°€</button>
          <button class="btn" id="undoBtn">ë§ˆì§€ë§‰ ì œê±°</button>
          <button class="btn danger" id="resetBtn">ì´ˆê¸°í™”</button>
        </div>
      </div>

      <h3>ë‹¨ê°€ ëª¨ë¸</h3>
      <div class="row">
        <div class="control">
          <label>ê¸°ë³¸ ìš”ê¸ˆ(â‚©)</label>
          <input type="number" id="baseFee" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>KM ë‹¨ê°€(â‚©/km)</label>
          <input type="number" id="perKm" value="1000" min="0" step="10">
        </div>
      </div>
      <div class="row">
        <div class="control">
          <label>ê²½ìœ ì§€ ì¶”ê°€ìš”ê¸ˆ(â‚©/ê°œ)</label>
          <input type="number" id="perStop" value="0" min="0" step="100">
        </div>
        <div class="control">
          <label>ìµœì†Œ ìš”ê¸ˆ(â‚©, ì„ íƒ)</label>
          <input type="number" id="minFee" value="0" min="0" step="100">
        </div>
      </div>

      <div class="kpi">
        <div class="card">
          <div class="label">ì´ ê±°ë¦¬</div>
          <div class="value"><span id="km">0.0</span> km</div>
        </div>
        <div class="card">
          <div class="label">ì˜ˆìƒ ê°„ì„ ë¹„</div>
          <div class="value">â‚© <span id="cost">0</span></div>
        </div>
      </div>

      <h3>ê²½ìœ ì§€</h3>
      <div class="waypoints" id="wpList">ê²½ë¡œë¥¼ ì„¤ì •í•˜ë©´ ì—¬ê¸°ì— ìˆœì„œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>

      <h3>ìŠ¬ë™ ê³µìœ </h3>
      <div class="slack">
        <div class="small">ë©”ì‹œì§€ ë¯¸ë¦¬ë³´ê¸°</div>
        <pre id="slackText" style="white-space: pre-wrap; margin:8px 0;"></pre>
        <button class="btn primary" id="copyBtn">ë©”ì‹œì§€ ë³µì‚¬</button>
      </div>
    </section>

    <!-- Map -->
    <section class="panel">
      <div id="map"></div>
    </section>
  </div>

  <!-- ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_JAVASCRIPT_KEY&libraries=services"></script>
  
  <script>
    // --- Data Storage (in-memory) ---
    let savedLocations = []; // {id, name, lat, lng, address}
    let currentSearchResult = null; // temporary location before saving

    // --- Map Init ---
    let map, ps, geocoder;
    let waypoints = [];
    let markers = [];
    let savedLocationMarkers = new Map(); // id -> marker
    let waypointMode = 'auto'; // 'auto' or 'waypoint'
    let polyline = null; // ê²½ë¡œë¥¼ ê·¸ë¦¬ëŠ” í´ë¦¬ë¼ì¸

    // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
    function initMap() {
      const container = document.getElementById('map');
      const options = {
        center: new kakao.maps.LatLng(37.5665, 126.9780), // ì„œìš¸ ì¤‘ì‹¬
        level: 8
      };

      map = new kakao.maps.Map(container, options);
      ps = new kakao.maps.services.Places(); // ì¥ì†Œ ê²€ìƒ‰ ì„œë¹„ìŠ¤
      geocoder = new kakao.maps.services.Geocoder(); // ì¢Œí‘œ-ì£¼ì†Œ ë³€í™˜ ì„œë¹„ìŠ¤

      // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
      kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
        const latlng = mouseEvent.latLng;
        
        if (waypointMode === 'waypoint') {
          if (waypoints.length >= 2) {
            addWaypoint(latlng);
            waypointMode = 'auto';
            updateAddWaypointButton();
          }
        } else {
          if (waypoints.length < 2) {
            addWaypoint(latlng);
          }
        }
      });
    }

    // DOMì´ ë¡œë“œëœ í›„ ì´ˆê¸°í™”
    window.addEventListener('DOMContentLoaded', function() {
      if (typeof kakao !== 'undefined' && kakao.maps) {
        initMap();
      } else {
        document.getElementById('map').innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; flex-direction: column; color: #666;">
            <p style="font-size: 16px; margin-bottom: 10px;">âš ï¸ ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ ì‹¤íŒ¨</p>
            <p style="font-size: 14px; text-align: center;">JavaScript í‚¤ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
            <p style="font-size: 12px; color: #999; margin-top: 10px;">
              <a href="https://developers.kakao.com" target="_blank">ì¹´ì¹´ì˜¤ ê°œë°œìì‚¬ì´íŠ¸</a>ì—ì„œ í‚¤ë¥¼ ë°œê¸‰ë°›ìœ¼ì„¸ìš”.
            </p>
          </div>
        `;
      }
    });

    // --- Search Functionality ---
    let searchTimeout;
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const saveLocationBtn = document.getElementById('saveLocationBtn');

    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        searchResults.style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(() => searchLocation(query), 300);
    });

    // Hide search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-container')) {
        searchResults.style.display = 'none';
      }
    });

    function searchLocation(query) {
      if (!ps) return;

      ps.keywordSearch(query, function(data, status) {
        if (status === kakao.maps.services.Status.OK) {
          displaySearchResults(data.slice(0, 5)); // ìƒìœ„ 5ê°œ ê²°ê³¼ë§Œ í‘œì‹œ
        } else {
          searchResults.innerHTML = '<div class="search-result">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
          searchResults.style.display = 'block';
        }
      }, {
        location: map.getCenter(), // í˜„ì¬ ì§€ë„ ì¤‘ì‹¬ ê¸°ì¤€ ê²€ìƒ‰
        radius: 50000 // 50km ë°˜ê²½
      });
    }

    function displaySearchResults(results) {
      searchResults.innerHTML = results.map(place => 
        `<div class="search-result" data-lat="${place.y}" data-lng="${place.x}" data-name="${place.place_name}" data-address="${place.address_name}">
          <div style="font-weight: 500;">${place.place_name}</div>
          <div style="font-size: 11px; color: #666; margin-top: 2px;">${place.address_name}</div>
        </div>`
      ).join('');
      searchResults.style.display = 'block';
    }

    // Handle search result selection
    searchResults.addEventListener('click', (e) => {
      const result = e.target.closest('.search-result');
      if (!result) return;

      const lat = parseFloat(result.dataset.lat);
      const lng = parseFloat(result.dataset.lng);
      const name = result.dataset.name;
      const address = result.dataset.address;

      // Clear previous search result marker
      if (currentSearchResult?.marker) {
        currentSearchResult.marker.setMap(null);
      }

      // Add temporary marker
      const markerPosition = new kakao.maps.LatLng(lat, lng);
      const marker = new kakao.maps.Marker({
        position: markerPosition,
        map: map
      });

      // ì»¤ìŠ¤í…€ ì˜¤ë²„ë ˆì´ë¡œ ê²€ìƒ‰ ì•„ì´ì½˜ í‘œì‹œ
      const overlay = new kakao.maps.CustomOverlay({
        position: markerPosition,
        content: '<div style="background: #fff; border: 2px solid #ff6b6b; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px;">ğŸ”</div>',
        yAnchor: 1,
        xAnchor: 0.5
      });
      overlay.setMap(map);

      currentSearchResult = { lat, lng, name: name + ' (' + address + ')', marker, overlay };
      
      map.setCenter(markerPosition);
      map.setLevel(3);
      searchResults.style.display = 'none';
      searchInput.value = name;
      saveLocationBtn.disabled = false;
    });

    // --- Save Location ---
    saveLocationBtn.addEventListener('click', () => {
      if (!currentSearchResult) return;

      const id = Date.now().toString();
      const shortName = prompt('ì´ ìœ„ì¹˜ë¥¼ ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', currentSearchResult.name.split(' (')[0]);
      
      if (!shortName) return;

      const location = {
        id,
        name: shortName,
        lat: currentSearchResult.lat,
        lng: currentSearchResult.lng,
        address: currentSearchResult.name
      };

      savedLocations.push(location);
      
      // Remove temporary marker and overlay
      if (currentSearchResult.marker) currentSearchResult.marker.setMap(null);
      if (currentSearchResult.overlay) currentSearchResult.overlay.setMap(null);
      currentSearchResult = null;
      
      // Add permanent marker
      addSavedLocationMarker(location);
      
      // Update UI
      renderSavedLocations();
      updateLocationDropdowns();
      saveLocationBtn.disabled = true;
      searchInput.value = '';
    });

    function addSavedLocationMarker(location) {
      const markerPosition = new kakao.maps.LatLng(location.lat, location.lng);
      const marker = new kakao.maps.Marker({
        position: markerPosition,
        map: map
      });

      // ì €ì¥ëœ ìœ„ì¹˜ ì˜¤ë²„ë ˆì´
      const overlay = new kakao.maps.CustomOverlay({
        position: markerPosition,
        content: `<div style="background: #fff; border: 2px solid #10b981; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ğŸ“</div>`,
        yAnchor: 1,
        xAnchor: 0.5
      });
      overlay.setMap(map);

      // ì¸í¬ìœˆë„ìš°
      const infowindow = new kakao.maps.InfoWindow({
        content: `<div style="padding: 5px; font-size: 12px;">${location.name}</div>`
      });

      kakao.maps.event.addListener(marker, 'mouseover', () => {
        infowindow.open(map, marker);
      });

      kakao.maps.event.addListener(marker, 'mouseout', () => {
        infowindow.close();
      });

      savedLocationMarkers.set(location.id, { marker, overlay });
    }

    function renderSavedLocations() {
      const container = document.getElementById('savedLocations');
      
      if (savedLocations.length === 0) {
        container.innerHTML = '<div class="hint">ì €ì¥ëœ ìœ„ì¹˜ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      container.innerHTML = savedLocations.map(loc => 
        `<div class="saved-location">
          <div class="name">${loc.name}</div>
          <div class="actions">
            <button class="btn" onclick="focusLocation('${loc.id}')">ğŸ“</button>
            <button class="btn danger" onclick="deleteLocation('${loc.id}')">ğŸ—‘ï¸</button>
          </div>
        </div>`
      ).join('');
    }

    function updateLocationDropdowns() {
      const startSelect = document.getElementById('startSelect');
      const endSelect = document.getElementById('endSelect');
      
      const options = savedLocations.map(loc => 
        `<option value="${loc.id}">${loc.name}</option>`
      ).join('');
      
      startSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + options;
      endSelect.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>' + options;
    }

    window.focusLocation = (id) => {
      const location = savedLocations.find(loc => loc.id === id);
      if (location) {
        map.setCenter(new kakao.maps.LatLng(location.lat, location.lng));
        map.setLevel(3);
      }
    };

    window.deleteLocation = (id) => {
      if (confirm('ì´ ìœ„ì¹˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        savedLocations = savedLocations.filter(loc => loc.id !== id);
        const markerData = savedLocationMarkers.get(id);
        if (markerData) {
          markerData.marker.setMap(null);
          markerData.overlay.setMap(null);
          savedLocationMarkers.delete(id);
        }
        renderSavedLocations();
        updateLocationDropdowns();
      }
    };

    // --- Route Planning ---
    document.getElementById('startSelect').addEventListener('change', updateRoute);
    document.getElementById('endSelect').addEventListener('change', updateRoute);

    function updateRoute() {
      const startId = document.getElementById('startSelect').value;
      const endId = document.getElementById('endSelect').value;
      
      if (!startId || !endId) return;
      
      const start = savedLocations.find(loc => loc.id === startId);
      const end = savedLocations.find(loc => loc.id === endId);
      
      if (start && end) {
        resetRoute();
        addWaypoint(new kakao.maps.LatLng(start.lat, start.lng), start.name);
        addWaypoint(new kakao.maps.LatLng(end.lat, end.lng), end.name);
      }
    }

    function addWaypoint(latlng, customName = null) {
      waypoints.push(latlng);
      const marker = new kakao.maps.Marker({
        position: latlng,
        map: map
      });

      const label = customName || ((waypoints.length === 1) ? 'ì¶œë°œ' : (waypoints.length === 2) ? 'ë„ì°©' : ('ê²½ìœ  ' + (waypoints.length-2)));
      
      // ì›¨ì´í¬ì¸íŠ¸ ì˜¤ë²„ë ˆì´
      const color = waypoints.length === 1 ? '#22c55e' : waypoints.length === 2 ? '#ef4444' : '#f59e0b';
      const overlay = new kakao.maps.CustomOverlay({
        position: latlng,
        content: `<div style="background: ${color}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; white-space: nowrap;">${label}</div>`,
        yAnchor: 2,
        xAnchor: 0.5
      });
      overlay.setMap(map);

      markers.push({ marker, overlay });
      
      if (waypoints.length >= 2) {
        calculateRoute();
      }
      renderWpList();
    }

    function calculateRoute() {
      // ê°„ë‹¨í•œ ì§ì„  ê±°ë¦¬ ê³„ì‚° (ì‹¤ì œ ë„ë¡œ ê±°ë¦¬ ê³„ì‚°ì„ ìœ„í•´ì„œëŠ” ì¹´ì¹´ì˜¤ ë‚´ë¹„ê²Œì´ì…˜ APIê°€ í•„ìš”)
      if (waypoints.length < 2) return;

      let totalDistance = 0;
      const path = [];

      for (let i = 0; i < waypoints.length; i++) {
        path.push(waypoints[i]);
        if (i > 0) {
          const prevLatLng = waypoints[i-1];
          const currLatLng = waypoints[i];
          
          // ë‘ ì  ì‚¬ì´ì˜ ê±°ë¦¬ ê³„ì‚° (í•˜ë²„ì‚¬ì¸ ê³µì‹)
          const distance = getDistanceFromLatLonInKm(
            prevLatLng.getLat(), prevLatLng.getLng(),
            currLatLng.getLat(), currLatLng.getLng()
          );
          totalDistance += distance;
        }
      }

      // ê¸°ì¡´ í´ë¦¬ë¼ì¸ ì œê±°
      if (polyline) {
        polyline.setMap(null);
      }

      // ìƒˆ í´ë¦¬ë¼ì¸ ê·¸ë¦¬ê¸°
      polyline = new kakao.maps.Polyline({
        path: path,
        strokeWeight: 6,
        strokeColor: '#6366f1',
        strokeOpacity: 0.8
      });
      polyline.setMap(map);

      // ê±°ë¦¬ ì—…ë°ì´íŠ¸
      document.getElementById('km').textContent = totalDistance.toFixed(1);
      renderCost();
    }

    // í•˜ë²„ì‚¬ì¸ ê³µì‹ìœ¼ë¡œ ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬ ê³„ì‚°
    function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
      const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
      const dLat = deg2rad(lat2-lat1);
      const dLon = deg2rad(lon2-lon1); 
      const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2)
        ; 
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      const d = R * c; // ê±°ë¦¬ (km)
      return d;
    }

    function deg2rad(deg) {
      return deg * (Math.PI/180)
    }

    function resetRoute() {
      waypoints = [];
      markers.forEach(m => {
        m.marker.setMap(null);
        m.overlay.setMap(null);
      });
      markers = [];
      if (polyline) {
        polyline.setMap(null);
        polyline = null;
      }
      document.getElementById('km').textContent = '0.0';
      waypointMode = 'auto';
      updateAddWaypointButton();
      renderWpList();
      renderCost();
    }

    function updateAddWaypointButton() {
      const btn = document.getElementById('addWaypointBtn');
      if (waypointMode === 'waypoint') {
        btn.textContent = 'ì§€ë„ í´ë¦­í•˜
